VERSION 5.00
Object = "{C932BA88-4374-101B-A56C-00AA003668DC}#1.1#0"; "MSMASK32.OCX"
Object = "{831FDD16-0C5C-11D2-A9FC-0000F8754DA1}#2.0#0"; "MSCOMCTL.OCX"
Begin VB.Form frmGerenciarNF 
   BorderStyle     =   1  'Fixed Single
   Caption         =   "Gerenciar Notas"
   ClientHeight    =   10260
   ClientLeft      =   45
   ClientTop       =   675
   ClientWidth     =   17190
   LinkTopic       =   "Form1"
   MaxButton       =   0   'False
   MinButton       =   0   'False
   ScaleHeight     =   10260
   ScaleWidth      =   17190
   StartUpPosition =   2  'CenterScreen
   Begin VB.Frame fraMensagensRetornoErros 
      Caption         =   "Mensagens de Retorno e Erros"
      Height          =   2055
      Left            =   60
      TabIndex        =   10
      Top             =   6660
      Width           =   9165
      Begin VB.CommandButton cmdHistorico 
         Caption         =   "Histórico"
         Height          =   375
         Left            =   6960
         TabIndex        =   13
         Top             =   1560
         Width           =   2115
      End
      Begin VB.CommandButton cmdLimparHistorico 
         Caption         =   "Limpar"
         Height          =   375
         Left            =   4740
         TabIndex        =   12
         Top             =   1560
         Width           =   2115
      End
      Begin MSComctlLib.ListView lvwMensagens 
         Height          =   1290
         Left            =   60
         TabIndex        =   11
         Top             =   240
         Width           =   9030
         _ExtentX        =   15928
         _ExtentY        =   2275
         View            =   3
         LabelEdit       =   1
         Sorted          =   -1  'True
         LabelWrap       =   -1  'True
         HideSelection   =   -1  'True
         FullRowSelect   =   -1  'True
         _Version        =   393217
         ForeColor       =   -2147483640
         BackColor       =   -2147483624
         BorderStyle     =   1
         Appearance      =   1
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         NumItems        =   0
      End
   End
   Begin VB.Frame fraFuncoesAdicionais 
      Height          =   1215
      Left            =   60
      TabIndex        =   3
      Top             =   8760
      Width           =   17055
      Begin VB.Timer tmrAtualiza 
         Interval        =   10000
         Left            =   16080
         Top             =   150
      End
      Begin VB.CommandButton cmdCopiarNFs 
         Caption         =   "Copiar NFs"
         Enabled         =   0   'False
         Height          =   375
         Left            =   1920
         TabIndex        =   26
         Top             =   720
         Width           =   1695
      End
      Begin VB.CommandButton cmdGerarPDF 
         Caption         =   "Gerar PDF"
         Enabled         =   0   'False
         Height          =   375
         Left            =   1920
         TabIndex        =   25
         Top             =   240
         Width           =   1695
      End
      Begin VB.CommandButton cmdEnviarEmail 
         Caption         =   "Enviar E-mail"
         Height          =   375
         Left            =   120
         TabIndex        =   21
         Top             =   720
         Width           =   1695
      End
      Begin VB.CommandButton cmdNFeCartaCorrecao 
         Caption         =   "Carta de Correção"
         Height          =   375
         Left            =   120
         TabIndex        =   20
         Top             =   240
         Width           =   1695
      End
      Begin VB.Timer tmrImprimirSistema 
         Interval        =   5000
         Left            =   16560
         Top             =   150
      End
      Begin VB.Label lblStatusEvento 
         BorderStyle     =   1  'Fixed Single
         Caption         =   "Status do Evento"
         Height          =   255
         Left            =   15540
         TabIndex        =   34
         Top             =   840
         Visible         =   0   'False
         Width           =   1395
      End
   End
   Begin VB.Frame fraInformacoes 
      Caption         =   "Informações"
      Height          =   8655
      Left            =   9300
      TabIndex        =   2
      Top             =   60
      Width           =   7815
      Begin VB.Frame fraNota 
         Height          =   6075
         Left            =   120
         TabIndex        =   23
         Top             =   2460
         Width           =   7575
         Begin VB.TextBox txtNota 
            Enabled         =   0   'False
            Height          =   315
            Left            =   120
            TabIndex        =   36
            Top             =   540
            Width           =   855
         End
         Begin VB.TextBox txtChaveNFe 
            Enabled         =   0   'False
            Height          =   315
            Left            =   1020
            TabIndex        =   35
            Top             =   540
            Width           =   4575
         End
         Begin VB.Label lblNota 
            Caption         =   "Número"
            Height          =   195
            Left            =   120
            TabIndex        =   38
            Top             =   300
            Width           =   795
         End
         Begin VB.Label lblChave 
            Caption         =   "Chave de Acesso"
            Height          =   195
            Left            =   1020
            TabIndex        =   37
            Top             =   300
            Width           =   1395
         End
      End
      Begin VB.Frame fraInformacoesClientes 
         Caption         =   "Cliente"
         Height          =   2175
         Left            =   120
         TabIndex        =   22
         Top             =   240
         Width           =   7575
         Begin VB.TextBox txtInformacoesCliente 
            Height          =   1455
            Left            =   120
            MultiLine       =   -1  'True
            TabIndex        =   39
            Top             =   240
            Width           =   7335
         End
         Begin VB.CommandButton cmdConsultarSefaz 
            Caption         =   "Consultar Sefaz"
            Enabled         =   0   'False
            Height          =   315
            Left            =   5760
            TabIndex        =   27
            Top             =   1740
            Width           =   1695
         End
         Begin VB.Label lblInformacoesCliente 
            Height          =   1335
            Left            =   120
            TabIndex        =   24
            Top             =   300
            Width           =   7275
         End
      End
   End
   Begin VB.Frame fraNotas 
      Caption         =   "Notas"
      Height          =   6555
      Left            =   60
      TabIndex        =   0
      Top             =   60
      Width           =   9165
      Begin VB.CommandButton cmdPesquisar 
         Caption         =   "&Pesquisar"
         Height          =   315
         Left            =   7620
         TabIndex        =   33
         Top             =   240
         Width           =   1155
      End
      Begin VB.Frame fraInformacoesNotas 
         Height          =   675
         Left            =   75
         TabIndex        =   28
         Top             =   5340
         Width           =   9000
         Begin VB.Label lblNotasIntuilizadas 
            Caption         =   "Inutilizadas"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H000000FF&
            Height          =   195
            Left            =   2400
            TabIndex        =   32
            Top             =   300
            Visible         =   0   'False
            Width           =   1815
         End
         Begin VB.Label lblNotasAprovadas 
            Caption         =   "Aprovadas"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00008000&
            Height          =   195
            Left            =   120
            TabIndex        =   31
            Top             =   300
            Visible         =   0   'False
            Width           =   1815
         End
         Begin VB.Label lblNotasCanceladas 
            Caption         =   "Canceladas"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H000000FF&
            Height          =   195
            Left            =   5040
            TabIndex        =   30
            Top             =   300
            Visible         =   0   'False
            Width           =   1815
         End
         Begin VB.Label lblNotasPendentes 
            Caption         =   "Pendentes"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H000000FF&
            Height          =   195
            Left            =   7320
            TabIndex        =   29
            Top             =   300
            Visible         =   0   'False
            Width           =   1575
         End
      End
      Begin VB.CommandButton cmdCancelarNota 
         Caption         =   "&Cancelar Nota"
         Enabled         =   0   'False
         Height          =   375
         Left            =   1380
         TabIndex        =   19
         Top             =   6060
         Width           =   1575
      End
      Begin VB.CommandButton cmdImprimirDANFE 
         Caption         =   "Imprimir DANFE"
         Enabled         =   0   'False
         Height          =   375
         Left            =   4740
         TabIndex        =   18
         Top             =   6060
         Width           =   1635
      End
      Begin VB.CommandButton cmdInutilizarNumeracao 
         Caption         =   "&Inutilizar Numeração"
         Height          =   375
         Left            =   3000
         TabIndex        =   17
         Top             =   6060
         Width           =   1695
      End
      Begin VB.CommandButton cmdConsultaNota 
         Caption         =   "Consulta Situação "
         Height          =   375
         Left            =   6420
         TabIndex        =   16
         Top             =   6060
         Width           =   1875
      End
      Begin VB.CommandButton cmdTransmitir 
         Caption         =   "&Transmitir"
         Enabled         =   0   'False
         Height          =   375
         Left            =   120
         TabIndex        =   15
         Top             =   6060
         Width           =   1155
      End
      Begin VB.ComboBox cmbSituacao 
         Height          =   315
         ItemData        =   "frmGerenciarNF.frx":0000
         Left            =   4770
         List            =   "frmGerenciarNF.frx":0019
         Style           =   2  'Dropdown List
         TabIndex        =   4
         Top             =   255
         Width           =   2805
      End
      Begin MSComctlLib.ListView lvwNFs 
         Height          =   4800
         Left            =   60
         TabIndex        =   1
         Top             =   600
         Width           =   9015
         _ExtentX        =   15901
         _ExtentY        =   8467
         View            =   3
         LabelEdit       =   1
         SortOrder       =   -1  'True
         Sorted          =   -1  'True
         LabelWrap       =   -1  'True
         HideSelection   =   -1  'True
         FullRowSelect   =   -1  'True
         _Version        =   393217
         ForeColor       =   -2147483640
         BackColor       =   -2147483624
         BorderStyle     =   1
         Appearance      =   1
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         NumItems        =   0
      End
      Begin MSMask.MaskEdBox mskDataInicial 
         Height          =   285
         Left            =   990
         TabIndex        =   5
         Top             =   270
         Width           =   975
         _ExtentX        =   1720
         _ExtentY        =   503
         _Version        =   393216
         MaxLength       =   10
         Mask            =   "99/99/9999"
         PromptChar      =   " "
      End
      Begin MSMask.MaskEdBox mskDataFinal 
         Height          =   285
         Left            =   2910
         TabIndex        =   6
         Top             =   270
         Width           =   975
         _ExtentX        =   1720
         _ExtentY        =   503
         _Version        =   393216
         MaxLength       =   10
         Mask            =   "99/99/9999"
         PromptChar      =   " "
      End
      Begin VB.Label lblDataFinal 
         AutoSize        =   -1  'True
         Caption         =   "Data Final"
         Height          =   195
         Left            =   2040
         TabIndex        =   9
         Top             =   315
         Width           =   720
      End
      Begin VB.Label lblDataInicial 
         AutoSize        =   -1  'True
         Caption         =   "Data Inicial"
         Height          =   195
         Left            =   90
         TabIndex        =   8
         Top             =   315
         Width           =   795
      End
      Begin VB.Label lblSituacao 
         AutoSize        =   -1  'True
         Caption         =   "Situação"
         ForeColor       =   &H80000008&
         Height          =   195
         Left            =   3990
         TabIndex        =   7
         Top             =   315
         Width           =   630
      End
   End
   Begin MSComctlLib.StatusBar StatusBar 
      Align           =   2  'Align Bottom
      Height          =   255
      Left            =   0
      TabIndex        =   14
      Top             =   10005
      Width           =   17190
      _ExtentX        =   30321
      _ExtentY        =   450
      _Version        =   393216
      BeginProperty Panels {8E3867A5-8586-11D1-B16A-00C0F0283628} 
         NumPanels       =   6
         BeginProperty Panel1 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Alignment       =   1
            AutoSize        =   1
            Object.Width           =   22578
            MinWidth        =   5380
         EndProperty
         BeginProperty Panel2 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Alignment       =   1
            Bevel           =   2
            Object.Width           =   2469
            MinWidth        =   2469
         EndProperty
         BeginProperty Panel3 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Style           =   3
            Alignment       =   1
            Enabled         =   0   'False
            Object.Width           =   1058
            MinWidth        =   1058
            TextSave        =   "INS"
         EndProperty
         BeginProperty Panel4 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Style           =   2
            Alignment       =   1
            Object.Width           =   1058
            MinWidth        =   1058
            TextSave        =   "NUM"
         EndProperty
         BeginProperty Panel5 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Style           =   1
            Alignment       =   1
            Enabled         =   0   'False
            Object.Width           =   1058
            MinWidth        =   1058
            TextSave        =   "CAPS"
         EndProperty
         BeginProperty Panel6 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Style           =   6
            Alignment       =   1
            AutoSize        =   2
            Object.Width           =   1931
            MinWidth        =   1940
            TextSave        =   "19/09/2018"
         EndProperty
      EndProperty
   End
   Begin VB.Menu mnuArquivos 
      Caption         =   "Arquivos"
   End
   Begin VB.Menu mnuLancamentos 
      Caption         =   "Lançamentos"
   End
   Begin VB.Menu mnuConfiguracoes 
      Caption         =   "Configurações"
   End
End
Attribute VB_Name = "frmGerenciarNF"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit
Dim ItemList As ListItem
Dim ProcuraItem As ListItem

'''Dim rsNFs As New ADODB.Recordset
'''Dim rsNFsItens As New ADODB.Recordset
Dim rsNFsInutilizadas As New ADODB.Recordset
'''Dim rsTotalNFs As ADODB.Recordset
Dim rsClientes As New ADODB.Recordset
Dim rsGerarXML As New ADODB.Recordset

Private SHA1Hash As New SHA1Hash

Private Sub Form_Activate()
   Me.Top = 200
End Sub

Private Sub Form_Load()
      
   lvwNFs.ColumnHeaders.Add , , "Número", 850
   lvwNFs.ColumnHeaders.Add , , "Emissão", 1050
   lvwNFs.ColumnHeaders.Add , , "Cliente", 4000
   lvwNFs.ColumnHeaders.Add , , "Valor Total", 1050, lvwColumnRight
   lvwNFs.ColumnHeaders.Add , , "Situação", 1700
   lvwNFs.ColumnHeaders.Add , , "", 0
   
   lvwMensagens.ColumnHeaders.Add , , "Chave", 0
   lvwMensagens.ColumnHeaders.Add , , "Número", 850
   lvwMensagens.ColumnHeaders.Add , , "Mensagem", 7850
   lvwMensagens.ColumnHeaders.Add , , "Arquivo", 0
   
''   mskDataInicial.text = Date - 1
   mskDataInicial.text = CDate("01" & Mid(Date, 3, 8))
   mskDataFinal.text = Date
   cmbSituacao.ListIndex = 0
   
   Call main
   
   Carrega_View ("Carregar")
   
End Sub

Private Sub lvwNFs_Click()
Dim oNFs400 As New CNF400
Dim oPreencherRs As New PreencherRS
   
   If lvwNFs.ListItems.Count <> 0 Then
      Call oPreencherRs.PreencherRsNFs(Val(lvwNFs.ListItems(lvwNFs.SelectedItem.Index)), "55")
      If Not rsNFs.EOF Then
         txtNota.text = StrZero(rsNFs!nNF, 8)
         txtChaveNFe.text = FFormataChaveNF(IIf(IsNull(rsNFs!cNF), "", rsNFs!cNF))
         txtInformacoesCliente.text = Space(7) & "CNPJ/CPF:" & vbTab & "[" & IIf(Trim(rsNFsDestinatarios!CNPJ) <> "", rsNFsDestinatarios!CNPJ, rsNFsDestinatarios!CPF) & "]" & vbTab & vbTab & "I.E.: [" & rsNFsDestinatarios!IE & "]" & vbCrLf & _
                                      Space(7) & "Nome:" & vbTab & "[" & rsNFsDestinatarios!xNome & "] " & vbCrLf & _
                                      Space(7) & "Endereço:" & vbTab & "[" & Trim(rsNFsDestinatarios!xLgr) & ", " & rsNFsDestinatarios!nro & "] " & vbCrLf & _
                                      Space(7) & "Bairro:" & vbTab & "[" & rsNFsDestinatarios!xBairro & "] " & vbCrLf & _
                                      Space(7) & "Município:" & vbTab & "[" & rsNFsDestinatarios!cMun & "] - [" & rsNFsDestinatarios!xMun & "]" & vbTab & "UF: [" & rsNFsDestinatarios!UF & "]" & vbTab & "CEP: [" & rsNFsDestinatarios!CEP & "] " & vbCrLf & _
                                      Space(7) & "Telefone:" & vbTab & "[" & rsNFsDestinatarios!fone & "]"
         
         cmdTransmitir.Enabled = rsNFs!Situacao
         
'''         If rsNFs!Situacao = 0 Then
'''            cmdTransmitir.Enabled = True
''''            cmdValidar.Enabled = True
'''         Else
'''            cmdTransmitir.Enabled = False
''''            cmdValidar.Enabled = False
'''         End If
      
         If rsNFs!Situacao = 2 Then
            If Trim(rsNFs!cNF) <> "" And Trim(rsNFs!Protocolo) <> "" Then
               cmdTransmitir.Enabled = False
               cmdCancelarNota.Enabled = True
               cmdImprimirDANFE.Enabled = True
            Else
               cmdTransmitir.Enabled = True
               cmdCancelarNota.Enabled = False
               cmdImprimirDANFE.Enabled = False
            End If
         Else
            cmdTransmitir.Enabled = True
            cmdCancelarNota.Enabled = False
            cmdImprimirDANFE.Enabled = False
         End If
         
      End If

'      Set rsGerarXML = cnSistema.Execute("Select * From NFe WHERE Numero=" & Val(lvwNFs.ListItems(lvwNFs.SelectedItem.Index)))
'      If Not rsGerarXML.EOF Then
''         txtNota.text = StrZero(rsGerarXML!Numero, 8)
''         txtChaveNFe.text = FFormataChaveNF(IIf(IsNull(rsGerarXML!ChaveNFe), "", rsGerarXML!ChaveNFe))
'
''         Call oPreencherRs.PreencherRsNFs(rsGerarXML!Numero, "55")
'
'         If rsGerarXML!Situacao = 0 Then
'            cmdTransmitir.Enabled = True
''            cmdValidar.Enabled = True
'         Else
'            cmdTransmitir.Enabled = False
''            cmdValidar.Enabled = False
'         End If
'
'         If rsGerarXML!Situacao = 2 Then
'            If Trim(rsGerarXML!ChaveNFe) <> "" And Trim(rsGerarXML!Protocolo) <> "" Then
'               cmdTransmitir.Enabled = False
'               cmdCancelarNota.Enabled = True
'               cmdImprimirDANFE.Enabled = True
'            Else
'               cmdTransmitir.Enabled = True
'               cmdCancelarNota.Enabled = False
'               cmdImprimirDANFE.Enabled = False
'            End If
'         End If
'      End If
   End If
End Sub

Private Sub tmrAtualiza_Timer()
   Carrega_View ("Atualizar")
End Sub

Private Sub Carrega_View(sModo As String)
On Error GoTo Erro

Dim sSituacao As String
Dim Contador As Integer

Dim sqlSituacao As String
Dim sSql As String

'   cmdCancelarNota.Enabled = False
'   cmdTransmitir.Enabled = False
   cmdImprimirDANFE.Enabled = False
   
   ' Validar Período
   If Not FValidarPeriodo(mskDataInicial.text, mskDataFinal.text) Then Exit Sub
   ' Retorna condição do SQL
   sqlSituacao = FSituacao("C", cmbSituacao.ListIndex)
   ' Carrega View
   If sModo = "Carregar" Then lvwNFs.ListItems.Clear

   ' Notas
   Contador = 1

   sSql = "       SELECT "
   sSql = sSql & "      N.idNFe, "
   sSql = sSql & "      N.idCliente, "
   sSql = sSql & "      N.Numero, "
   sSql = sSql & "      N.DataEmissao, "
   sSql = sSql & "      C.Nome, "
   sSql = sSql & "      (T.Total + T.TotalFrete) AS Total, "
   sSql = sSql & "      N.Situacao "
   sSql = sSql & "FROM "
   sSql = sSql & "      NFe N, Clientes C, TotalNFe T "
   sSql = sSql & "WHERE "
   sSql = sSql & "      N.idCliente = C.idCliente AND "
   sSql = sSql & "      N.idNFe = T.idNFe AND "
   sSql = sSql & "      N.DataEmissao >= cDate('" & Format(mskDataInicial.text, "dd/mm/yyyy") & "') AND "
   sSql = sSql & "      N.DataEmissao <= cDate('" & Format(mskDataFinal.text, "dd/mm/yyyy") & "') "
   sSql = sSql & sqlSituacao & " Order By N.Numero"
   
   Set rsNFs = cnSistema.Execute(sSql)
   Do While Not rsNFs.EOF
      sSituacao = FSituacao("S", rsNFs!Situacao)      ' Retorna Situação atual da nota
      
      ' Pesquisa se registro existe
      Set ItemList = lvwNFs.FindItem(StrZero(rsNFs!Numero, 8))
      If ItemList Is Nothing Then
         Set ItemList = lvwNFs.ListItems.Add(, "R" & CStr(Contador), StrZero(rsNFs!Numero, 8))
      End If
      
      ItemList.SubItems(1) = rsNFs!DataEmissao
      ItemList.SubItems(2) = Trim(rsNFs!Nome)
      ItemList.SubItems(3) = Format(rsNFs!Total, "##,##0.00")
      ItemList.SubItems(4) = sSituacao
      
      Contador = Contador + 1
      rsNFs.MoveNext
   Loop
   
   ' Notas
   Set rsNFsInutilizadas = cnSistema.Execute("SELECT * FROM NFeInutilizadas WHERE Data >= cDate('" & Format(mskDataInicial.text, "dd/mm/yyyy") & "') AND Data <= cDate('" & Format(mskDataFinal.text, "dd/mm/yyyy") & "') Order By Numero")

   If Not rsNFsInutilizadas.EOF Then
      Do While Not rsNFsInutilizadas.EOF

'         Set ItemList = lvwNFs.ListItems.Add(, "I" & CStr(rsNFsInutilizadas!Numero), StrZero(rsNFsInutilizadas!Numero, 8))

         Set ProcuraItem = lvwNFs.FindItem(StrZero(rsNFsInutilizadas!Numero, 8))
         If ProcuraItem Is Nothing Then
            Set ItemList = lvwNFs.ListItems.Add(, "I" & CStr(Contador), StrZero(rsNFsInutilizadas!Numero, 8))
            ItemList.SubItems(1) = rsNFsInutilizadas!Data
            ItemList.SubItems(2) = "Nota Inutilizada"
            ItemList.SubItems(3) = Format(0, "##,##0.00")
            ItemList.SubItems(4) = "Inutilizada"
            If IsNull(rsNFsInutilizadas!Protocolo) Or rsNFsInutilizadas!Protocolo = "" Then
               ItemList.SubItems(5) = "Aguarde..."
            Else
               ItemList.SubItems(5) = ""
            End If
         End If

         Contador = Contador + 1
         rsNFsInutilizadas.MoveNext
      Loop
   End If
   
   Exit Sub
Erro:
   MsgBox "Erro " & Err & ". " & Err.Description & " - " & TypeName(Me) & ".Carrega_View"
End Sub

Private Sub cmdConsultaNota_Click()
Dim sMotivo
Dim iNumeroConsultar As Integer

   tmrAtualiza.Enabled = False
   If MsgBox("Confirma Consulta NF-e", vbYesNo + vbQuestion, "Confirmação") = vbYes Then
      iNumeroConsultar = Val(lvwNFs.ListItems(lvwNFs.SelectedItem.Index))
      Dim oNFe400 As New CNF400
       
      Call oNFe400.FConsultarNumero(iNumeroConsultar)
   End If
   tmrAtualiza.Enabled = True

End Sub

Private Sub cmdInutilizarNumeracao_Click()
   lblStatusEvento.Tag = "IN"
   frmEventos.Show vbModal
End Sub

Private Sub cmdCancelarNota_Click()
   cmdCancelarNota.Tag = Val(lvwNFs.ListItems(lvwNFs.SelectedItem.Index))
   lblStatusEvento.Tag = "CN"
   frmEventos.Show vbModal
End Sub

Private Sub cmdNFeCartaCorrecao_Click()
   lblStatusEvento.Tag = "CC"
   frmEventos.Show vbModal
End Sub

Private Sub cmdPesquisar_Click()
   Carrega_View ("Carregar")
End Sub

Private Sub cmdTransmitir_Click()
Dim sVerArquivo As String
Dim oImportar As New CImportar
Dim iNumeroNota As Integer
Dim sEmpresaNF As String
Dim sModeloNF As String
Dim I_ModeloNF As String

   ' Popular número da nota
   iNumeroNota = FNumeroNF()
   If iNumeroNota > 0 Then
'''      ' Importar Casa Grande
'''      ' Verifica se existe Cupom a ser importado
'''      sVerArquivo = Dir(I_UnidadeNFe & "NFC-e\Notas\CUPOM.TXT")
'''      If sVerArquivo = "CUPOM.TXT" Then
'''         Call oImportar.FImportarCupom
'''         Kill I_UnidadeNFe & "NFC-e\Notas\CUPOM.TXT"
'''      End If
   
      ' Gerar o arquivo XML
      Open ARQUIVO_NFE_NOTAS For Output As #1
      Call NotasNFs(iNumeroNota)
      Close #1
   
      ' Validar e Assinar o XML
      sEmpresaNF = LerArquivoINI("NFe", "Empresa", CaminhoINI & "\System.ini")
      FileCopy I_UnidadeNFe & "NF-e\Notas\Notas.TXT", I_UnidadeNFe & "NF-e\" & sEmpresaNF & "\Validar\" & rsNFs!cNF & "-nfe.XML"
      Kill I_UnidadeNFe & "NF-e\Notas\Notas.TXT"
   
      ' Atualiza Nota para Processamento
      sModeloNF = "55"
      If sModeloNF = "55" Then
         I_ModeloNF = "NFe"
      ElseIf sModeloNF = "65" Then
         I_ModeloNF = "NFe"
      End If

      ' Define como Gerada
      cnSistema.Execute "Update " & I_ModeloNF & " set " & _
               "Situacao = 1 " & _
               "Where Numero = " & iNumeroNota
   
   End If
   
'''   'Gerar o XML
'''   Set rsGerarXML = cnSistema.Execute("Select TOP 1 * From NFe WHERE Situacao = 0") ' Em digitação
'''   If Not rsGerarXML.EOF Then
'''      Open I_UnidadeNFe & "NFC-e\Notas\Notas.TXT" For Output As #1
'''
'''      NFeNumero = rsGerarXML!Numero
'''
'''      ' Executa a Geração do arquivo XML
'''      Call NotasNFs(rsGerarXML!Numero)
'''      Close #1

'''      ' Validar e Assinar o XML
'''      sEmpresaNFe = LerArquivoINI("NFe", "Empresa", CaminhoINI & "\System.ini")
'''      FileCopy I_UnidadeNFe & "NFC-e\Notas\Notas.TXT", I_UnidadeNFe & "NFC-e\" & sEmpresaNFe & "\Validar\" & sChaveNFe & "-nfe.XML"
'''      Kill I_UnidadeNFe & "NFC-e\Notas\Notas.TXT"
      
'''      ' Define como Gerada
'''      cnSistema.Execute "Update NFe set " & _
'''               "Situacao = 1 " & _
'''               "Where idNFe = " & rsGerarXML!idNFe
'''   End If

'''   APENAS PARA NFC-e
'''   ================================================================
'''   'Gerar o QrCode
'''   Set rsGerarXML = cnSistema.Execute("Select TOP 1 * From NFe WHERE Situacao = 1") ' Em processamento
'''   If Not rsGerarXML.EOF Then
'''      If Not IsNull(rsGerarXML!ChaveNFe) Then
'''         sChaveNFe = rsGerarXML!ChaveNFe
'''         sVerArquivo = Dir(I_UnidadeNFe & "NFC-e\" & sEmpresaNFe & "\Validar\Validado\" & sChaveNFe & "-nfe.XML")
'''         If sVerArquivo = (sChaveNFe & "-nfe.XML") Then
'''            GerarQrCode (rsGerarXML!Numero)
'''         Else
'''            If rsGerarXML!TentativaEmissao < 15 Then
'''               cnSistema.Execute "Update NFe set " & _
'''                        "TentativaEmissao = " & (rsGerarXML!TentativaEmissao + 1) & " " & _
'''                        "Where idNFe = " & rsGerarXML!idNFe
'''            Else
'''               cnSistema.Execute "Update NFe set " & _
'''                        "Situacao = 4 " & _
'''                        "Where idNFe = " & rsGerarXML!idNFe
'''            End If
'''         End If
'''      End If
'''   End If

End Sub

Private Function NotasNFs(iNumero As Integer)
On Error GoTo Erro
Dim oNFe400 As New CNF400
Dim oPreencherRs As New PreencherRS

'   Set rsEmpresa = cnSistema.Execute("Select * From Empresa")

   ' Criar XML de envio
   ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'   Call oPreencherRs.PreencherRsNFs(iNumero, "55")
   
   
   ' Popular RecordSets com os dados da Nota selecionada
   ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'   Dim Total_NFCes As Integer
'   Set rsTemp = cnSistema.Execute("Select Count(*) as Qte from NFCe WHERE Numero = " & Val(lvwNFCes.ListItems(lvwNFCes.SelectedItem.Index)))
'   Set rsTemp = cnSistema.Execute("Select Count(*) as Qte from NFCe WHERE Numero = " & NFCeNumero)
'   Set rsTemp = cnSistema.Execute("Select Count(*) as Qte from NFCe WHERE Numero = " & iNumero)
'   Total_NFCes = rsTemp!Qte

'   Set rsNFCe = cnSistema.Execute("Select * From NFCe WHERE Numero=" & Val(lvwNFCes.ListItems(lvwNFCes.SelectedItem.Index)))
'   Set rsNFCe = cnSistema.Execute("Select * From NFCe WHERE Numero=" & NFCeNumero)
'   Set rsNFCe = cnSistema.Execute("Select * From NFCe WHERE Numero=" & iNumero)
   
   If Not rsNFs.EOF Then
      ' Corpo do XML
      ' B. Identificação da Nota Fiscal eletrônica
      Call oNFe400.NotasNFsGrupoB(iNumero)
      
      ' C. Identificação do Emitente da Nota Fiscal eletrônica
      Call oNFe400.NotasNFsGrupoC
      
      ' E. Identificação do Destinatário da Nota Fiscal eletrônica
      If rsNFCe!idCliente <> 1 Then
         Call oNFe400.NotasNFsGrupoE(iNumero)
      End If
      
      ' H. Detalhamento de Produtos e Serviços da NF-e
      Call oNFe400.NotasNFsGrupoH(iNumero)
      
      ' W. Detalhamento de Produtos e Serviços da NF-e
      Call oNFe400.NotasNFsGrupoW(iNumero)
      
      ' X. Total da NF-e
      Call oNFe400.NotasNFsGrupoX(iNumero)
      
      ' Y. Dados da Cobrança
      Call oNFe400.NotasNFsGrupoY(iNumero)
      
      ' Z. Dados da Cobrança
      Call oNFe400.NotasNFsGrupoZ(iNumero)
      
      ' -------------------------------------------
      
      Print #1, Space(2) & "</infNFe>"
      
      Print #1, "</NFe>"
     
   End If
   
   Exit Function
Erro:
    MsgBox "Erro " & Err & ". " & Err.Description & " - " & TypeName(Me) & ".NotasNFs"
End Function

Private Function FNumeroNF() As Integer
On Error GoTo Erro

   If lvwNFs.ListItems.Count > 0 Then
      FNumeroNF = Val(lvwNFs.ListItems(lvwNFs.SelectedItem.Index))
   Else
      FNumeroNF = 0
   End If

   Exit Function
Erro:
   MsgBox "Erro " & Err & ". " & Err.Description & " - " & TypeName(Me) & ".FNumeroNF"
End Function

Private Function FValidarPeriodo(DataInicial As String, DataFinal As String) As Boolean
On Error GoTo Erro
Dim strMensagem As String

   FValidarPeriodo = True

   If Not IsDate(mskDataInicial.text) Then strMensagem = "Data Inicial Inválida" & Chr(13)
   If Not IsDate(mskDataFinal.text) Then strMensagem = "Data Final Inválida" & Chr(13)
   If (CDate(mskDataInicial.text) > CDate(mskDataFinal.text)) Then strMensagem = "Data Inicial maior que Data Final"

   If Not strMensagem = Empty Then
      MsgBox "Verifique os Seguintes Campos:" & Chr(13) & strMensagem, vbExclamation + vbOKOnly, "Campos Obrigatórios"
      FValidarPeriodo = False
      Exit Function
   End If

   Exit Function
Erro:
   MsgBox "Erro " & Err & ". " & Err.Description & " - " & TypeName(Me) & ".FValidarPeriodo"
End Function

Private Function FSituacao(Parametro As String, Conteudo As Integer) As String
On Error GoTo Erro

   If Parametro = "C" Then       ' Condição
'      If Conteudo = 0 Then FSituacao = "AND Situacao <> 2"
      If Conteudo = 0 Then FSituacao = ""
      If Conteudo = 1 Then FSituacao = " AND Situacao = 0"
      If Conteudo = 2 Then FSituacao = " AND Situacao = 1"
      If Conteudo = 3 Then FSituacao = " AND Situacao = 2"
      If Conteudo = 4 Then FSituacao = " AND Situacao = 3"
      If Conteudo = 5 Then FSituacao = " AND Situacao = 4"
      If Conteudo = 6 Then FSituacao = " AND Situacao = 5"
   End If
   
   If Parametro = "S" Then       ' Condição
      If Conteudo = 0 Then FSituacao = "Em Digitação"
      If Conteudo = 1 Then FSituacao = "Processamento"
      If Conteudo = 2 Then FSituacao = "Aprovada"
      If Conteudo = 3 Then FSituacao = "Cancelada"
      If Conteudo = 4 Then FSituacao = "Não Emitida"
      If Conteudo = 5 Then FSituacao = "Denegada"
   End If
   
   Exit Function
Erro:
   MsgBox "Erro " & Err & ". " & Err.Description & " - " & TypeName(Me) & ".FSituacao"
End Function


Private Sub cmdEnviarEmail_Click()
Dim sArquivo As String
Dim sCaminho As String
Dim cdoConfiguration As CDO.Configuration
Dim cdoData As ADODB.Fields
Dim cdoMensagem As New CDO.Message
Dim strMensagem As String
   
   Set rsNFs = cnSistema.Execute("Select * From NFe WHERE Numero=" & Val(lvwNFs.ListItems(lvwNFs.SelectedItem.Index)))
   Set rsClientes = cnSistema.Execute("Select * From Clientes WHERE idCliente = " & rsNFs!idCliente)
   
   If Trim(rsClientes!Email) = "" Then
      MsgBox "E-mail do cliente não encontrado", vbExclamation + vbOKOnly, "Campos Obrigatórios"
      Exit Sub
   End If
   
'''''''''''''''''''''''''''''''''''''''''''''

   strMensagem = strMensagem & "De: " & rsEmpresa!Nome & Chr(13)
   strMensagem = strMensagem & "E-mail: " & rsEmpresa!Email & Chr(13)
   strMensagem = strMensagem & Chr(13)
   strMensagem = strMensagem & "Para: " & rsClientes!Nome & Chr(13)
   strMensagem = strMensagem & "E-mail: " & rsClientes!Email & Chr(13)
   strMensagem = strMensagem & Chr(13)
   strMensagem = strMensagem & "Estamos enviando em anexo arquivo XML da nota fiscal N. " & rsNFs!Numero

'''''''''''''''''''''''''''''''''''''''''''''
   
   If MsgBox("Envio de E-mail " & Chr(13) & strMensagem, vbYesNo + vbQuestion, "Confirmação") = vbYes Then

'' Para Consulta
''Item(cdoSendUsingMethod) = 2
''  .Item(cdoSMTPServer) = "pop.mail.yahoo.com.br"
''  .Item(cdoSMTPServerPort) = 995
''  .Item(cdoSMTPConnectionTimeout) = 15
''  .Item(cdoSMTPAuthenticate) = cdoBasic
''  .Item(cdoSMTPUseSSL) = True
''  .Item(cdoSendUserName) = vUser
''  .Item(cdoSendPassword) = vPass
''  .Update
   
      sEmpresaNFe = LerArquivoINI("NFe", "Empresa", CaminhoINI & "\System.ini")
'      sArquivo = I_Unidadenfe & "NFC-e\" & sEmpresaNFe & "\Enviados\Autorizados\" & Format(rsNFe!DataEmissao, "yyyymmdd") & "\" & rsNFe!ChaveNFe & "-procNFe.XML"
      sArquivo = I_CaminhoXML_NFe & sEmpresaNFe & "\Enviados\Autorizados\" & Format(rsNFe!DataEmissao, "yyyymm") & "\" & rsNFe!ChaveNFe & "-procNFe.XML"
      If Dir(sArquivo) <> "" Then
         Set cdoConfiguration = New CDO.Configuration
         Set cdoData = cdoConfiguration.Fields
         Set rsEmpresa = cnSistema.Execute("SELECT * FROM Empresa")
         With cdoData
            .Item(cdoSendUsingMethod) = 2
            .Item(cdoSMTPServerPort) = LerArquivoINI("EMail", "Porta", CaminhoINI & "\System.ini")
            .Item(cdoSMTPServer) = rsEmpresa!ServidorSMTP 'rsSistema!Mail_SMTP
            .Item(cdoSMTPConnectionTimeout) = 20
            .Item(cdoSMTPAuthenticate) = 1
            .Item(cdoSMTPUseSSL) = True
            .Item(cdoSendUserName) = rsEmpresa!EmailUsuario 'rsSistema!Mail_User
            .Item(cdoSendPassword) = rsEmpresa!EmailSenha 'rsSistema!Mail_Pass
            .Update
         End With
         
         Set cdoMensagem = New CDO.Message
         With cdoMensagem
            Set .Configuration = cdoConfiguration
                .To = rsClientes!Email 'rsTotal!Email
                .From = rsEmpresa!Email 'rsSistema!Mail_From
                .Subject = rsEmpresa!Nome 'rsSistema!Mail_Subject
                .HTMLBody = "Estamos enviando em anexo arquivo XML da nota fiscal N. " & rsNFe!Numero  'rsSistema!Mail_Body
                .AddAttachment sArquivo 'rsSistema!Mail_Directory & "\" & rsTotal!idFaturamento & ".pdf"
                .Send
         End With
         
         MsgBox "E-mail Enviado", vbExclamation + vbOKOnly, "Informação"
      Else
         MsgBox "Arquivo: " & sArquivo & " Não encontrado", vbExclamation + vbOKOnly, "Campos Obrigatórios"
      End If
   End If
   
   Set cdoMensagem = Nothing

End Sub

Private Sub cmdImprimirDANFE_Click()
Dim sArquivo As String
Dim sCaminho As String
   
   Set rsNFs = cnSistema.Execute("Select * From NFe WHERE Numero=" & Val(lvwNFs.ListItems(lvwNFs.SelectedItem.Index)))
   
   sEmpresaNFe = LerArquivoINI("NFe", "Empresa", CaminhoINI & "\System.ini")
'   sArquivo = I_Unidadenfe & "NFC-e\" & sEmpresaNFe & "\Enviados\Autorizados\" & Format(rsNFe!DataEmissao, "yyyymmdd") & "\" & rsNFe!ChaveNFe & "-procNFe.XML"
   sArquivo = I_CaminhoXML_NFe & sEmpresaNFe & "\Enviados\Autorizados\" & Format(rsNFe!DataEmissao, "yyyymm") & "\" & rsNFe!ChaveNFe & "-procNFe.XML"
   
   Shell "C:\UNIMAKE\" & sEmpresaNFe & "\UNIDANFE\UNIDANFE.EXE arquivo=" & sArquivo & " visualizar = 1"
'   Shell "C:\UNIMAKE\" & sEmpresaNFe & "\UNIDANFE\UNIDANFE.EXE a=" & sArquivo & " v=0 i=selecionar"

End Sub

Private Sub cmdHistorico_Click()
   frmLerXML.Show
End Sub

Private Sub cmdLimparHistorico_Click()
   lvwMensagens.ListItems.Clear
End Sub

Private Sub cmdGerarPDF_Click()
Dim sArquivo As String
Dim sCaminho As String
Dim sImpressoraUSB As String

   sImpressoraUSB = LerArquivoINI("NFe", "ImpressoraUSB", CaminhoINI & "\System.ini")
   
   Set rsNFs = cnSistema.Execute("Select * From NFe WHERE Numero=" & Val(lvwNFs.ListItems(lvwNFs.SelectedItem.Index)))
   
   sEmpresaNFe = LerArquivoINI("NFe", "Empresa", CaminhoINI & "\System.ini")
'   sArquivo = I_Unidadenfe & "NFC-e\" & sEmpresaNFe & "\Enviados\Autorizados\" & Format(rsNFe!DataEmissao, "yyyymmdd") & "\" & rsNFe!ChaveNFe & "-procNFe.XML"
   sArquivo = I_CaminhoXML_NFe & sEmpresaNFe & "\Enviados\Autorizados\" & Format(rsNFe!DataEmissao, "yyyymm") & "\" & rsNFe!ChaveNFe & "-procNFe.XML"
   
   Shell "C:\UNIMAKE\" & sEmpresaNFe & "\UNIDANFE\UNIDANFE.EXE arquivo=" & sArquivo & " visualizar = 0 " & "i=" & sImpressoraUSB
'   Shell "C:\UNIMAKE\" & sEmpresaNFe & "\UNIDANFE\UNIDANFE.EXE a=" & sArquivo & " v=0 i=selecionar"
End Sub

'===========================================================================================================================================
'===========================================================================================================================================
'===========================================================================================================================================
'===========================================================================================================================================

Private Sub tmrImprimirSistema_Timer()
Dim handle As Integer
Dim Linha As String
Dim iCopia As Integer
Dim Contador As Integer
Dim sVerArquivo As String
Dim OldFont As String
 
   sVerArquivo = Dir(LerArquivoINI("Arquivos", "Caminho", App.Path & "\System.ini"))
   If sVerArquivo = "IMPRIMIR.PRN" Then
      handle = FreeFile
      Open LerArquivoINI("Arquivos", "Caminho", App.Path & "\System.ini") For Input As #handle               '' Abre arquivo importado
      While Not EOF(handle)
         Line Input #handle, Linha
         If Mid(Linha, 1, 3) = "<CP" Then
            iCopia = Mid(Linha, 4, 2)
         End If
      Wend
      Close #handle

      ' Determina o número mínimo de cópias
      If iCopia = 0 Then iCopia = 1
      
      For Contador = 1 To iCopia
         ' Alterar fonte
         OldFont = Printer.FontName            ' Preserva a fonte original.
         Printer.FontName = LerArquivoINI("Arquivos", "Fonte", App.Path & "\System.ini")
         Printer.FontSize = LerArquivoINI("Arquivos", "Tamanho", App.Path & "\System.ini")
         Printer.FontBold = True

         ' Abrir arquivo
         handle = FreeFile

         Open LerArquivoINI("Arquivos", "Caminho", App.Path & "\System.ini") For Input As #handle               '' Abre arquivo importado
         While Not EOF(handle)
            Line Input #handle, Linha
            If Mid(Linha, 1, 3) <> "<CP" Then
               Printer.Print Linha
            End If
         Wend
         Close #handle
         Printer.FontName = OldFont   ' Restaura a fonte original.
         Printer.EndDoc
      Next

      Kill LerArquivoINI("Arquivos", "Caminho", App.Path & "\System.ini")
   End If

End Sub


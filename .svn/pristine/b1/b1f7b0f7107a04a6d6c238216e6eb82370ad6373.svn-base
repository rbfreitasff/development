VERSION 5.00
Object = "{C932BA88-4374-101B-A56C-00AA003668DC}#1.1#0"; "MSMASK32.OCX"
Object = "{831FDD16-0C5C-11D2-A9FC-0000F8754DA1}#2.1#0"; "mscomctl.OCX"
Begin VB.Form frmGerenciarNF 
   BorderStyle     =   1  'Fixed Single
   Caption         =   "Gerenciar Notas"
   ClientHeight    =   10260
   ClientLeft      =   45
   ClientTop       =   675
   ClientWidth     =   17190
   LinkTopic       =   "Form1"
   MaxButton       =   0   'False
   MinButton       =   0   'False
   ScaleHeight     =   10260
   ScaleWidth      =   17190
   StartUpPosition =   2  'CenterScreen
   Begin VB.Frame fraMensagensRetornoErros 
      Caption         =   "Mensagens de Retorno e Erros"
      Height          =   2055
      Left            =   60
      TabIndex        =   10
      Top             =   6660
      Width           =   9165
      Begin VB.CommandButton cmdHistorico 
         Caption         =   "Histórico"
         Height          =   375
         Left            =   6960
         TabIndex        =   13
         Top             =   1560
         Width           =   2115
      End
      Begin VB.CommandButton cmdLimparHistorico 
         Caption         =   "Limpar"
         Height          =   375
         Left            =   4740
         TabIndex        =   12
         Top             =   1560
         Width           =   2115
      End
      Begin MSComctlLib.ListView lvwMensagens 
         Height          =   1290
         Left            =   60
         TabIndex        =   11
         Top             =   240
         Width           =   9030
         _ExtentX        =   15928
         _ExtentY        =   2275
         View            =   3
         LabelEdit       =   1
         Sorted          =   -1  'True
         LabelWrap       =   -1  'True
         HideSelection   =   -1  'True
         FullRowSelect   =   -1  'True
         _Version        =   393217
         ForeColor       =   -2147483640
         BackColor       =   -2147483624
         BorderStyle     =   1
         Appearance      =   1
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         NumItems        =   0
      End
   End
   Begin VB.Frame fraFuncoesAdicionais 
      Height          =   1215
      Left            =   60
      TabIndex        =   3
      Top             =   8760
      Width           =   17055
      Begin VB.CommandButton cmdCopiarNFs 
         Caption         =   "Copiar NFs"
         Enabled         =   0   'False
         Height          =   375
         Left            =   1920
         TabIndex        =   26
         Top             =   720
         Width           =   1695
      End
      Begin VB.CommandButton cmdGerarPDF 
         Caption         =   "Gerar PDF"
         Enabled         =   0   'False
         Height          =   375
         Left            =   1920
         TabIndex        =   25
         Top             =   240
         Width           =   1695
      End
      Begin VB.CommandButton cmdEnviarEmail 
         Caption         =   "Enviar E-mail"
         Height          =   375
         Left            =   120
         TabIndex        =   21
         Top             =   720
         Width           =   1695
      End
      Begin VB.CommandButton cmdNFeCartaCorrecao 
         Caption         =   "Carta de Correção"
         Enabled         =   0   'False
         Height          =   375
         Left            =   120
         TabIndex        =   20
         Top             =   240
         Width           =   1695
      End
      Begin VB.Timer tmrImprimirSistema 
         Interval        =   5000
         Left            =   16560
         Top             =   150
      End
   End
   Begin VB.Frame fraInformacoes 
      Caption         =   "Informações"
      Height          =   8655
      Left            =   9300
      TabIndex        =   2
      Top             =   60
      Width           =   7815
      Begin VB.Frame Frame2 
         Caption         =   "Nota"
         Height          =   6075
         Left            =   120
         TabIndex        =   23
         Top             =   2460
         Width           =   7575
      End
      Begin VB.Frame fraInformacoesClientes 
         Caption         =   "Cliente"
         Height          =   2175
         Left            =   120
         TabIndex        =   22
         Top             =   240
         Width           =   7575
         Begin VB.CommandButton cmdConsultarSefaz 
            Caption         =   "Consultar Sefaz"
            Enabled         =   0   'False
            Height          =   315
            Left            =   5760
            TabIndex        =   27
            Top             =   1740
            Width           =   1695
         End
         Begin VB.Label lblInformacoesCliente 
            Height          =   1335
            Left            =   120
            TabIndex        =   24
            Top             =   300
            Width           =   7275
         End
      End
   End
   Begin VB.Frame fraNotas 
      Caption         =   "Notas"
      Height          =   6555
      Left            =   60
      TabIndex        =   0
      Top             =   60
      Width           =   9165
      Begin VB.Frame fraInformacoesNotas 
         Height          =   675
         Left            =   75
         TabIndex        =   28
         Top             =   5340
         Width           =   9000
         Begin VB.Label lblNotasIntuilizadas 
            Caption         =   "Inutilizadas"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H000000FF&
            Height          =   195
            Left            =   2400
            TabIndex        =   32
            Top             =   300
            Visible         =   0   'False
            Width           =   1815
         End
         Begin VB.Label lblNotasAprovadas 
            Caption         =   "Aprovadas"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00008000&
            Height          =   195
            Left            =   120
            TabIndex        =   31
            Top             =   300
            Visible         =   0   'False
            Width           =   1815
         End
         Begin VB.Label lblNotasCanceladas 
            Caption         =   "Canceladas"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H000000FF&
            Height          =   195
            Left            =   5040
            TabIndex        =   30
            Top             =   300
            Visible         =   0   'False
            Width           =   1815
         End
         Begin VB.Label lblNotasPendentes 
            Caption         =   "Pendentes"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H000000FF&
            Height          =   195
            Left            =   7320
            TabIndex        =   29
            Top             =   300
            Visible         =   0   'False
            Width           =   1575
         End
      End
      Begin VB.CommandButton cmdCancelarNota 
         Caption         =   "&Cancelar Nota"
         Enabled         =   0   'False
         Height          =   375
         Left            =   1380
         TabIndex        =   19
         Top             =   6060
         Width           =   1575
      End
      Begin VB.CommandButton cmdImprimirDANFECe 
         Caption         =   "Imprimir DANFE"
         Enabled         =   0   'False
         Height          =   375
         Left            =   4740
         TabIndex        =   18
         Top             =   6060
         Width           =   1635
      End
      Begin VB.CommandButton cmdInutilizarNumeracao 
         Caption         =   "&Inutilizar Numeração"
         Height          =   375
         Left            =   3000
         TabIndex        =   17
         Top             =   6060
         Width           =   1695
      End
      Begin VB.CommandButton cmdConsultaNota 
         Caption         =   "Consulta Situação "
         Height          =   375
         Left            =   6420
         TabIndex        =   16
         Top             =   6060
         Width           =   1875
      End
      Begin VB.CommandButton cmdTransmitir 
         Caption         =   "&Transmitir"
         Height          =   375
         Left            =   120
         TabIndex        =   15
         Top             =   6060
         Width           =   1155
      End
      Begin VB.ComboBox cmbSituacao 
         Height          =   315
         Left            =   4770
         Style           =   2  'Dropdown List
         TabIndex        =   4
         Top             =   255
         Width           =   2805
      End
      Begin MSComctlLib.ListView lvwNFs 
         Height          =   4800
         Left            =   60
         TabIndex        =   1
         Top             =   600
         Width           =   9015
         _ExtentX        =   15901
         _ExtentY        =   8467
         View            =   3
         LabelEdit       =   1
         SortOrder       =   -1  'True
         Sorted          =   -1  'True
         LabelWrap       =   -1  'True
         HideSelection   =   -1  'True
         FullRowSelect   =   -1  'True
         _Version        =   393217
         ForeColor       =   -2147483640
         BackColor       =   -2147483624
         BorderStyle     =   1
         Appearance      =   1
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         NumItems        =   0
      End
      Begin MSMask.MaskEdBox mskDataInicial 
         Height          =   285
         Left            =   990
         TabIndex        =   5
         Top             =   270
         Width           =   975
         _ExtentX        =   1720
         _ExtentY        =   503
         _Version        =   393216
         MaxLength       =   10
         Mask            =   "99/99/9999"
         PromptChar      =   " "
      End
      Begin MSMask.MaskEdBox mskDataFinal 
         Height          =   285
         Left            =   2910
         TabIndex        =   6
         Top             =   270
         Width           =   975
         _ExtentX        =   1720
         _ExtentY        =   503
         _Version        =   393216
         MaxLength       =   10
         Mask            =   "99/99/9999"
         PromptChar      =   " "
      End
      Begin VB.Label lblDataFinal 
         AutoSize        =   -1  'True
         Caption         =   "Data Final"
         Height          =   195
         Left            =   2040
         TabIndex        =   9
         Top             =   315
         Width           =   720
      End
      Begin VB.Label lblDataInicial 
         AutoSize        =   -1  'True
         Caption         =   "Data Inicial"
         Height          =   195
         Left            =   90
         TabIndex        =   8
         Top             =   315
         Width           =   795
      End
      Begin VB.Label lblSituacao 
         AutoSize        =   -1  'True
         Caption         =   "Situação"
         ForeColor       =   &H80000008&
         Height          =   195
         Left            =   3990
         TabIndex        =   7
         Top             =   315
         Width           =   630
      End
   End
   Begin MSComctlLib.StatusBar StatusBar 
      Align           =   2  'Align Bottom
      Height          =   255
      Left            =   0
      TabIndex        =   14
      Top             =   10005
      Width           =   17190
      _ExtentX        =   30321
      _ExtentY        =   450
      _Version        =   393216
      BeginProperty Panels {8E3867A5-8586-11D1-B16A-00C0F0283628} 
         NumPanels       =   6
         BeginProperty Panel1 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Alignment       =   1
            AutoSize        =   1
            Object.Width           =   22578
            MinWidth        =   5380
         EndProperty
         BeginProperty Panel2 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Alignment       =   1
            Bevel           =   2
            Object.Width           =   2469
            MinWidth        =   2469
         EndProperty
         BeginProperty Panel3 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Style           =   3
            Alignment       =   1
            Enabled         =   0   'False
            Object.Width           =   1058
            MinWidth        =   1058
            TextSave        =   "INS"
         EndProperty
         BeginProperty Panel4 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Style           =   2
            Alignment       =   1
            Enabled         =   0   'False
            Object.Width           =   1058
            MinWidth        =   1058
            TextSave        =   "NUM"
         EndProperty
         BeginProperty Panel5 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Style           =   1
            Alignment       =   1
            Enabled         =   0   'False
            Object.Width           =   1058
            MinWidth        =   1058
            TextSave        =   "CAPS"
         EndProperty
         BeginProperty Panel6 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Style           =   6
            Alignment       =   1
            AutoSize        =   2
            Object.Width           =   1931
            MinWidth        =   1940
            TextSave        =   "28/07/2018"
         EndProperty
      EndProperty
   End
   Begin VB.Menu mnuArquivos 
      Caption         =   "Arquivos"
   End
   Begin VB.Menu mnuLancamentos 
      Caption         =   "Lançamentos"
   End
   Begin VB.Menu mnuConfiguracoes 
      Caption         =   "Configurações"
   End
End
Attribute VB_Name = "frmGerenciarNF"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit
Dim ItemList As ListItem
Dim ProcuraItem As ListItem

Private SHA1Hash As New SHA1Hash

Private Sub Form_Load()
      
   Call main
   
   lvwNFs.ColumnHeaders.Add , , "Número", 850
   lvwNFs.ColumnHeaders.Add , , "Emissão", 1050
   lvwNFs.ColumnHeaders.Add , , "Cliente", 4000
   lvwNFs.ColumnHeaders.Add , , "Valor Total", 1050, lvwColumnRight
   lvwNFs.ColumnHeaders.Add , , "Situação", 1700
   
   lvwMensagens.ColumnHeaders.Add , , "Chave", 0
   lvwMensagens.ColumnHeaders.Add , , "Número", 850
   lvwMensagens.ColumnHeaders.Add , , "Mensagem", 7850
   lvwMensagens.ColumnHeaders.Add , , "Arquivo", 0
   
End Sub

Private Sub cmdTransmitir_Click()
Dim sVerArquivo As String
Dim oImportar As New CImportar
Dim iNumeroNota As Integer
Dim sEmpresaNF As String
Dim sModeloNF As String
Dim I_ModeloNF As String

   ' Popular número da nota
   iNumeroNota = FNumeroNF()
   If iNumeroNota > 0 Then
'''      ' Importar Casa Grande
'''      ' Verifica se existe Cupom a ser importado
'''      sVerArquivo = Dir(I_UnidadeNFe & "NFC-e\Notas\CUPOM.TXT")
'''      If sVerArquivo = "CUPOM.TXT" Then
'''         Call oImportar.FImportarCupom
'''         Kill I_UnidadeNFe & "NFC-e\Notas\CUPOM.TXT"
'''      End If
   
      ' Gerar o arquivo XML
      Open ARQUIVO_NFE_NOTAS For Output As #1
      Call NotasNFs(iNumeroNota)
      Close #1
   
      ' Validar e Assinar o XML
      sEmpresaNF = LerArquivoINI("NFe", "Empresa", CaminhoINI & "\System.ini")
      FileCopy I_UnidadeNFe & "NF-e\Notas\Notas.TXT", I_UnidadeNFe & "NF-e\" & sEmpresaNF & "\Validar\" & rsNFs!cNF & "-nfe.XML"
      Kill I_UnidadeNFe & "NF-e\Notas\Notas.TXT"
   
      ' Atualiza Nota para Processamento
      sModeloNF = "55"
      If sModeloNF = "55" Then
         I_ModeloNF = "NFe"
      ElseIf sModeloNF = "65" Then
         I_ModeloNF = "NFCe"
      End If

      ' Define como Gerada
      cnSistema.Execute "Update " & I_ModeloNF & " set " & _
               "Situacao = 1 " & _
               "Where Numero = " & iNumeroNota
   
   End If
   
'''   'Gerar o XML
'''   Set rsGerarXML = cnSistema.Execute("Select TOP 1 * From NFCe WHERE Situacao = 0") ' Em digitação
'''   If Not rsGerarXML.EOF Then
'''      Open I_UnidadeNFe & "NFC-e\Notas\Notas.TXT" For Output As #1
'''
'''      NFCeNumero = rsGerarXML!Numero
'''
'''      ' Executa a Geração do arquivo XML
'''      Call NotasNFs(rsGerarXML!Numero)
'''      Close #1

'''      ' Validar e Assinar o XML
'''      sEmpresaNFCe = LerArquivoINI("NFe", "Empresa", CaminhoINI & "\System.ini")
'''      FileCopy I_UnidadeNFe & "NFC-e\Notas\Notas.TXT", I_UnidadeNFe & "NFC-e\" & sEmpresaNFCe & "\Validar\" & sChaveNFe & "-nfe.XML"
'''      Kill I_UnidadeNFe & "NFC-e\Notas\Notas.TXT"
      
'''      ' Define como Gerada
'''      cnSistema.Execute "Update NFCe set " & _
'''               "Situacao = 1 " & _
'''               "Where idNFCe = " & rsGerarXML!idNFCe
'''   End If

'''   APENAS PARA NFC-e
'''   ================================================================
'''   'Gerar o QrCode
'''   Set rsGerarXML = cnSistema.Execute("Select TOP 1 * From NFCe WHERE Situacao = 1") ' Em processamento
'''   If Not rsGerarXML.EOF Then
'''      If Not IsNull(rsGerarXML!ChaveNFCe) Then
'''         sChaveNFe = rsGerarXML!ChaveNFCe
'''         sVerArquivo = Dir(I_UnidadeNFe & "NFC-e\" & sEmpresaNFCe & "\Validar\Validado\" & sChaveNFe & "-nfe.XML")
'''         If sVerArquivo = (sChaveNFe & "-nfe.XML") Then
'''            GerarQrCode (rsGerarXML!Numero)
'''         Else
'''            If rsGerarXML!TentativaEmissao < 15 Then
'''               cnSistema.Execute "Update NFCe set " & _
'''                        "TentativaEmissao = " & (rsGerarXML!TentativaEmissao + 1) & " " & _
'''                        "Where idNFCe = " & rsGerarXML!idNFCe
'''            Else
'''               cnSistema.Execute "Update NFCe set " & _
'''                        "Situacao = 4 " & _
'''                        "Where idNFCe = " & rsGerarXML!idNFCe
'''            End If
'''         End If
'''      End If
'''   End If

End Sub

Private Function FNumeroNF() As Integer
On Error GoTo Erro

   If lvwNFs.ListItems.Count > 0 Then
      FNumeroNF = Val(lvwNFs.ListItems(lvwNFs.SelectedItem.Index))
   Else
      FNumeroNF = 0
   End If

   Exit Function
Erro:
   MsgBox "Erro " & Err & ". " & Err.Description & " - " & TypeName(Me) & ".FNumeroNF"
End Function

'===========================================================================================================================================

Private Sub tmrImprimirSistema_Timer()
Dim handle As Integer
Dim Linha As String
Dim iCopia As Integer
Dim Contador As Integer
Dim sVerArquivo As String
Dim OldFont As String
 
   sVerArquivo = Dir(LerArquivoINI("Arquivos", "Caminho", App.Path & "\System.ini"))
   If sVerArquivo = "IMPRIMIR.PRN" Then
      handle = FreeFile
      Open LerArquivoINI("Arquivos", "Caminho", App.Path & "\System.ini") For Input As #handle               '' Abre arquivo importado
      While Not EOF(handle)
         Line Input #handle, Linha
         If Mid(Linha, 1, 3) = "<CP" Then
            iCopia = Mid(Linha, 4, 2)
         End If
      Wend
      Close #handle

      ' Determina o número mínimo de cópias
      If iCopia = 0 Then iCopia = 1
      
      For Contador = 1 To iCopia
         ' Alterar fonte
         OldFont = Printer.FontName            ' Preserva a fonte original.
         Printer.FontName = LerArquivoINI("Arquivos", "Fonte", App.Path & "\System.ini")
         Printer.FontSize = LerArquivoINI("Arquivos", "Tamanho", App.Path & "\System.ini")
         Printer.FontBold = True

         ' Abrir arquivo
         handle = FreeFile

         Open LerArquivoINI("Arquivos", "Caminho", App.Path & "\System.ini") For Input As #handle               '' Abre arquivo importado
         While Not EOF(handle)
            Line Input #handle, Linha
            If Mid(Linha, 1, 3) <> "<CP" Then
               Printer.Print Linha
            End If
         Wend
         Close #handle
         Printer.FontName = OldFont   ' Restaura a fonte original.
         Printer.EndDoc
      Next

      Kill LerArquivoINI("Arquivos", "Caminho", App.Path & "\System.ini")
   End If

End Sub

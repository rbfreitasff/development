VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
  Persistable = 0  'NotPersistable
  DataBindingBehavior = 0  'vbNone
  DataSourceBehavior  = 0  'vbNone
  MTSTransactionMode  = 0  'NotAnMTSObject
END
Attribute VB_Name = "PreencherRS"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = False
'---------------------------------------------------------------------------------------
' Procedure : PreencherRS
' Author    : Robinson.Fernandes
' Date      : 04/06/2018
' Purpose   :
'---------------------------------------------------------------------------------------

'''''Public Function PreencherRsNFs(ByVal iNumero As Integer, ByVal sModeloNF As String)
Public Function PreencherRsNFs(ByVal iNumero As Integer)
'''''Dim rsNF As New ADODB.Recordset
'''''Dim rsNaturezasOperacao As New ADODB.Recordset
'''''Dim rsCFOPs As New ADODB.Recordset

'''''   If sModeloNF = "55" Then
'''''      I_ModeloNF = "NFe"
'''''   ElseIf sModeloNF = "65" Then
'''''      I_ModeloNF = "NFCe"
'''''   End If

'''''   Set rsNF = cnSistema.Execute("Select * From " & I_TabelasNF & " WHERE Numero=" & iNumero)
'''''   If Not rsNF.EOF Then
'''''      Set rsNaturezasOperacao = cnSistema.Execute("Select * From NaturezasOperacao WHERE idNaturezaOperacao=" & rsNF!idNaturezaOperacao)
'''''      Set rsCFOPs = cnSistema.Execute("Select * From CFOPs WHERE idCFOP=" & rsNF!idCFOP)
'''''      Set rsClientes = cnSistema.Execute("Select * From Clientes WHERE idCliente=" & rsNF!idCliente)
   
      ' Cria RercordSets da NF escolhida
      Call CriarEstruturaNFs
      
      ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      ' Natureza da Operação 'COMPLEMENTO DE VALOR'
      '
      ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
      
      ' Preencher Cabecalho NF
      Call PreencherRsDadosNota(iNumero)
      
      ' Preencher Emitente
      Call PreencherRsEmitentes
      
      ' Preencher Destinatario
      Call PreencherRsDestinatarios
      
      ' Preencher Itens
      Call PreencherRsItens(iNumero, sModeloNF)
      
      ' Preencher Formas de Pagamento
' Testar
      Call PreencherRsFormasPagamento(iNumero)
      
      ' Preencher Totais
' Finalizar
'      Call PreencherRsTotais(iNumero)
      
'''''   End If
'''''
'''''   Set rsNF = Nothing
'''''   Set rsNaturezasOperacao = Nothing
'''''   Set rsCFOPs = Nothing
'''''   Set rsClientes = Nothing
   
End Function

Public Function CriarEstruturaNFs()

   Set rsNFs = Nothing
   Set rsNFsItens = Nothing
   Set rsNFsPagamentos = Nothing
   Set rsNFsTotaisICMS = Nothing
   Set rsNFsTotaisISS = Nothing
   Set rsNFsEmitentes = Nothing
   Set rsNFsDestinatarios = Nothing
   Set rsNFsTransportes = Nothing

   ' Criar Estrutura NFs
   '------------------------------------------------------------------------------------------
    With rsNFs
      .Fields.Append "idCliente", adInteger                  ' Id do Cliente
      .Fields.Append "Situacao", adInteger                   ' Situação da Nota
      .Fields.Append "Protocolo", adVarChar, 20              ' Protocolo de Aprovação
      
      .Fields.Append "cUF", adVarChar, 2                     ' UF
      .Fields.Append "cNF", adVarChar, 44                    ' Chave da NF
      .Fields.Append "natOp", adVarChar, 30                  ' Natureza Operação
      .Fields.Append "mod", adVarChar, 2                     ' Modelo (55 - NFe / 65 - NFCe)
      .Fields.Append "serie", adVarChar, 1                   ' Serie (1)
      .Fields.Append "nNF", adVarChar, 9                     ' Número da Nota
      .Fields.Append "dhEmi", adVarChar, 25                  ' Data da Emissão [Gerar Padrão Horário de Verão]
      .Fields.Append "dhSaiEnt", adVarChar, 25               ' Data da Saida [Gerar Padrão Horário de Verão]
      .Fields.Append "tpNF", adVarChar, 1                    ' Tipo de NF (0 - Entrada / 1 - Saida)
      .Fields.Append "idDest", adVarChar, 1                  ' Tipo de Destinatário (1. Operacao Interna / 2. Operacao Interestadual)
      .Fields.Append "cMunFG", adVarChar, 7                  ' Codigo do Municipio
      .Fields.Append "tpImp", adVarChar, 1                   ' Tipo de Sistemas (0 - Utilizando Software próprio)
      .Fields.Append "tpEmis", adVarChar, 1                  ' Tipo de Emissao (1)
      .Fields.Append "cDV", adVarChar, 1                     ' Digito Verificador da Chave de Acesso
      .Fields.Append "tpAmb", adVarChar, 1                   ' Tipo de Ambiente (1 - Produção ou 2 - Homologação)
      .Fields.Append "finNFe", adVarChar, 1                  ' Finalidade (1 - NFe Normal / 2 - Complementar / 3 - Ajuste)
      .Fields.Append "indFinal", adVarChar, 1                ' Finalidade (1 - NFe Normal / 2 - Complementar / 3 - Ajuste)
      .Fields.Append "indPres", adVarChar, 1                 ' Indicador de Presença (1 - Presencial)
      .Fields.Append "procEmi", adVarChar, 1                 ' Processo de emissão  (0 - Utilizando Software próprio)
      .Fields.Append "verProc", adVarChar, 15                ' Versão do Aplicativo
      
      .Fields.Refresh
      .Open
    End With
      
   ' Criar Estrutura Emitentes
   '------------------------------------------------------------------------------------------
    With rsNFsEmitentes
      .Fields.Append "nNF", adVarChar, 9                     ' Número da Nota
      .Fields.Append "CNPJ", adVarChar, 20                   ' CNPJ
      .Fields.Append "CPF", adVarChar, 20                    ' CPF
      .Fields.Append "xNome", adVarChar, 50                  ' Nome
      .Fields.Append "xFant", adVarChar, 50                  ' Nome Fantasia
      .Fields.Append "xLgr", adVarChar, 50                   ' Logradouro
      .Fields.Append "nro", adVarChar, 15                    ' Numero
      .Fields.Append "xBairro", adVarChar, 50                ' Bairro
      .Fields.Append "cMun", adVarChar, 15                   ' Codigo Municipio
      .Fields.Append "xMun", adVarChar, 50                   ' Nome Municipio
      .Fields.Append "UF", adVarChar, 2                      ' UF
      .Fields.Append "CEP", adVarChar, 10                    ' CEP
      .Fields.Append "cPais", adVarChar, 10                  ' Codigo do Pais
      .Fields.Append "xPais", adVarChar, 50                  ' Nome do Pais
      .Fields.Append "fone", adVarChar, 20                   ' Telefone
      .Fields.Append "IE", adVarChar, 20                     ' IE
      .Fields.Append "CNAE", adVarChar, 20                   ' CNAE
      .Fields.Append "IM", adVarChar, 20                     ' IM
      .Fields.Append "CRT", adVarChar, 20                    ' CRT
      
      .Fields.Refresh
      .Open
    End With
    
   ' Criar Estrutura Destinatário
   '------------------------------------------------------------------------------------------
    With rsNFsDestinatarios
      .Fields.Append "nNF", adVarChar, 9                     ' Número da Nota
      .Fields.Append "CNPJ", adVarChar, 20                   ' CNPJ
      .Fields.Append "CPF", adVarChar, 20                    ' CPF
      .Fields.Append "xNome", adVarChar, 50                  ' Nome
      .Fields.Append "xLgr", adVarChar, 50                   ' Logradouro
      .Fields.Append "nro", adVarChar, 15                    ' Numero
      .Fields.Append "xBairro", adVarChar, 50                ' Bairro
      .Fields.Append "cMun", adVarChar, 15                   ' Codigo Municipio
      .Fields.Append "xMun", adVarChar, 50                   ' Nome Municipio
      .Fields.Append "UF", adVarChar, 2                      ' UF
      .Fields.Append "CEP", adVarChar, 10                    ' CEP
      .Fields.Append "cPais", adVarChar, 10                  ' Codigo do Pais
      .Fields.Append "xPais", adVarChar, 50                  ' Nome do Pais
      .Fields.Append "fone", adVarChar, 20                   ' Telefone
      .Fields.Append "indIEDest", adVarChar, 1               ' Indicador de Tipo de Contribuinte
      .Fields.Append "IE", adVarChar, 20                     ' IE
      
      .Fields.Refresh
      .Open
    End With

   ' Criar Estrutura Itens
   '------------------------------------------------------------------------------------------
    With rsNFsItens
      .Fields.Append "nNF", adVarChar, 9                     ' Número da Nota
      .Fields.Append "cProd", adVarChar, 20                  ' Código do Produto
      .Fields.Append "cEAN", adVarChar, 20                   ' Codigo de Barras
      .Fields.Append "xProd", adVarChar, 60                  ' Descrição do produto
      .Fields.Append "NCM", adVarChar, 20                    ' Código do NCM
      .Fields.Append "CFOP", adVarChar, 4                    ' Codigo do FCOP
      .Fields.Append "uCom", adVarChar, 3                    ' Unidade Comercial
      .Fields.Append "qCom", adDouble, 19                    ' Quantidade Comercial
      .Fields.Append "vUnCom", adDouble, 19                  ' Valor Unitário Comercial
      .Fields.Append "vProd", adDouble, 19                   ' Valor Total Produtos
      .Fields.Append "cEANTrib", adVarChar, 20               ' ?
      .Fields.Append "uTrib", adVarChar, 3                   ' Unidade Tributavel
      .Fields.Append "qTrib", adDouble, 19                   ' Quantidade Tributavel
      .Fields.Append "vUnTrib", adDouble, 19                 ' Valor Unitário Tributavel
      .Fields.Append "indTot", adVarChar, 1                  ' Indicador de Totalização
'      .Fields.Append "xPed", adVarChar, 4                    ' ?
'      .Fields.Append "nItemPed", adVarChar, 4                ' ?

      .Fields.Append "orig", adVarChar, 1                    ' Origem
      .Fields.Append "CSOSN", adVarChar, 3                   ' CST / CSON
      
      .Fields.Append "vBCSTRet", adDouble, 19                ' Valor Base Calculo ST Ret
      .Fields.Append "vICMSSTRet", adDouble, 19              ' Valor ICMS Calculo ST Ret
      .Fields.Append "pCredSN", adDouble, 19                 ' Percentual de crédito
      .Fields.Append "vCredICMSSN", adDouble, 19             ' Valor do crédito de ICMS

      .Fields.Append "modBCST", adVarChar, 1                 '
      .Fields.Append "pMVAST", adDouble, 19                  '
      .Fields.Append "pRedBCST", adDouble, 19                '
      .Fields.Append "vBCST", adDouble, 19                   '
      .Fields.Append "pICMSST", adDouble, 19                 '
      .Fields.Append "vICMSST", adDouble, 19                 '
      .Fields.Append "vBCFCPST", adDouble, 19                '
      .Fields.Append "pFCPST", adDouble, 19                  '
      .Fields.Append "vFCPST", adDouble, 19                  '

      .Fields.Append "PIS", adVarChar, 2                     '
      .Fields.Append "COFINS", adVarChar, 2                  '

      .Fields.Append "AliqICMS", adDouble, 19                ' Percentual de Aliquota do ICMS
      .Fields.Append "Desconto", adDouble, 19                ' Valor do Desconto
      .Fields.Append "ValorFrete", adDouble, 19              ' Valor do Frete

      .Fields.Append "vBCISS", adDouble, 19                  ' Base de Calculo ISS
      .Fields.Append "vAliqISS", adDouble, 19                ' Aliquota do ISS
      .Fields.Append "vISSQN", adDouble, 19                  ' Valor do ISSQN
      .Fields.Append "cMunFGISS", adVarChar, 7               ' Codigo Municipio ISS
      .Fields.Append "cListServISS", adVarChar, 5            '
      .Fields.Append "indISS", adVarChar, 1                  ' Indicador do ISS
      .Fields.Append "indIncentivoISS", adVarChar, 1         ' Indicador do Incentivo ISS

      .Fields.Refresh
      .Open
    End With

   ' Criar Estrutura Pagamentos
   '------------------------------------------------------------------------------------------
    With rsNFsPagamentos
      .Fields.Append "nNF", adVarChar, 9                       ' Número da Nota
      .Fields.Append "tPag", adVarChar, 2                      ' Indicador de Pagamentos
      .Fields.Append "vPag", adDouble, 19                      ' Valor do Pagamento
      
      .Fields.Refresh
      .Open
    End With

   ' Criar Estrutura Totais ICMS
   '------------------------------------------------------------------------------------------
   
   ''''<vBC>0.00</vBC>
   ''''<vICMS>0.00</vICMS>
   ''''<vICMSDeson>0.00</vICMSDeson>
   ''''<vFCPUFDest>0.00</vFCPUFDest>
   ''''<vICMSUFDest>0.00</vICMSUFDest>
   ''''<vICMSUFRemet>0.00</vICMSUFRemet>
   ''''<vFCP>0.00</vFCP>
   ''''<vBCST>0.00</vBCST>
   ''''<vST>0.00</vST>
   ''''<vFCPST>0.00</vFCPST>
   ''''<vFCPSTRet>0.00</vFCPSTRet>
   ''''<vProd>3834.50</vProd>
   ''''<vFrete>0.00</vFrete>
   ''''<vSeg>0.00</vSeg>
   ''''<vDesc>0.00</vDesc>
   ''''<vII>0.00</vII>
   ''''<vIPI>0.00</vIPI>
   ''''<vIPIDevol>0.00</vIPIDevol>
   ''''<vPIS>0.00</vPIS>
   ''''<vCOFINS>0.00</vCOFINS>
   ''''<vOutro>0.00</vOutro>
   ''''<vNF>3834.50</vNF>
   ''''<vTotTrib>271.17</vTotTrib>

    With rsNFsTotaisICMS
      .Fields.Append "nNF", adVarChar, 9                     ' Número da Nota
      .Fields.Append "vBC", adDouble, 19                     ' Base de Calculo
      .Fields.Append "vICMS", adDouble, 19                   ' Valor do ICMS
      .Fields.Append "vICMSDeson", adDouble, 19              ' Valor do ICMS Deson
      .Fields.Append "vFCPUFDest", adDouble, 19              ' vFCPUFDest
      .Fields.Append "vICMSUFDest", adDouble, 19             ' vICMSUFDest
      .Fields.Append "vICMSUFRemet", adDouble, 19            ' vICMSUFRemet
      .Fields.Append "vFCP", adDouble, 19                    ' vFCP
      .Fields.Append "vBCST", adDouble, 19                   ' Base de Calculo Substituicao
      .Fields.Append "vST", adDouble, 19                     ' Valor da Substituicao
      .Fields.Append "vFCPST", adDouble, 19                  ' vFCPST
      .Fields.Append "vFCPSTRet", adDouble, 19               ' vFCPSTRet
      .Fields.Append "vProd", adDouble, 19                   ' Valor Total dos Produtos
      .Fields.Append "vFrete", adDouble, 19                  ' Valor Total do Frete
      .Fields.Append "vSeg", adDouble, 19                    ' Valor Total do Seguro
      .Fields.Append "vDesc", adDouble, 19                   ' Valor Total do Desconto
      .Fields.Append "vII", adDouble, 19                     ' Valor Total Isento
      .Fields.Append "vIPI", adDouble, 19                    ' Valor Total IPI
      .Fields.Append "vIPIDevol", adDouble, 19               ' Valor Total IPI Devolvido
      .Fields.Append "vPIS", adDouble, 19                    ' Valor Total PIS
      .Fields.Append "vCOFINS", adDouble, 19                 ' Valor Total COFINS
      .Fields.Append "vOutro", adDouble, 19                  ' Valor Total Outros
      .Fields.Append "vNF", adDouble, 19                     ' Valor Total NF
      .Fields.Append "vTotTrib", adDouble, 19                ' Valor Total Tributos
      
      .Fields.Refresh
      .Open
    End With

   ' Criar Estrutura Totais ISS
   '------------------------------------------------------------------------------------------
    With rsNFsTotaisISS
      .Fields.Append "nNF", adVarChar, 9                          ' Número da Nota
      .Fields.Append "vServ", adDouble, 19                        ' Valor dos Serviços
      .Fields.Append "vBC", adDouble, 19                          ' Valor da Base de Calculo
      .Fields.Append "vISS", adDouble, 19                         ' Valor do ISS
      .Fields.Append "dCompet", advarcar, 8                       ' Data
      .Fields.Append "cRegTrib", advarcar, 1                      ' Regime
      
      .Fields.Refresh
      .Open
    End With

   ' Criar Estrutura do Transportador
   '------------------------------------------------------------------------------------------
    With rsNFsTransportes
      .Fields.Append "nNF", adVarChar, 9                          ' Número da Nota
      .Fields.Append "modFrete", adVarChar, 1                     ' Modalidade do Frete
      .Fields.Append "CNPJ", adVarChar, 14                        ' CNPJ do Transportador
      .Fields.Append "xNome", adVarChar, 50                       ' Nome do Transportador
      .Fields.Append "IE", adVarChar, 20                          ' Inscrição Estadual
      .Fields.Append "xEnder", adVarChar, 60                      ' Endereço
      .Fields.Append "xMun", adVarChar, 30                        ' Nome do Municipio
      .Fields.Append "UF", adVarChar, 2                           ' UF
      .Fields.Append "placa", adVarChar, 10                       ' Placa
      .Fields.Append "UFVeiculo", adVarChar, 2                    ' UF do Veiculo
      
      .Fields.Refresh
      .Open
    End With

End Function

Public Function PreencherRsDadosNota(ByVal iNumero As Integer)
Dim rsNF As New ADODB.Recordset
Dim rsNaturezasOperacao As New ADODB.Recordset
Dim rsCFOPs As New ADODB.Recordset

   Set rsNF = cnSistema.Execute("Select * From " & I_TabelasNF & " WHERE Numero=" & iNumero)
   If Not rsNF.EOF Then
      Set rsNaturezasOperacao = cnSistema.Execute("Select * From NaturezasOperacao WHERE idNaturezaOperacao=" & rsNF!idNaturezaOperacao)
      Set rsCFOPs = cnSistema.Execute("Select * From CFOPs WHERE idCFOP=" & rsNF!idCFOP)
      Set rsClientes = cnSistema.Execute("Select * From Clientes WHERE idCliente=" & rsNF!idCliente)

      rsNFs.AddNew
      rsNFs!idCliente = rsNF!idCliente                                                          ' id do Cliente
      rsNFs!Situacao = rsNF!Situacao                                                            ' Situação da Nota
      rsNFs!Protocolo = IIf(IsNull(rsNF!Protocolo), "", rsNF!Protocolo)                         ' Protocolo de Aprovação
      rsNFs!cUF = I_EmpresaCodigoUF                                                             ' UF

      If I_ModeloNF = "55" Then
         If Not IsNull(rsNF!ChaveNFe) Or rsNF!ChaveNFe = "" Then
            rsNFs!cNF = rsNF!ChaveNFe                                                           ' Chave da NF
         Else
            rsNFs!cNF = FGerarChaveNF(iNumero, rsNF!DataEmissao, I_ModeloNF)                    ' Chave da NF
         End If
      ElseIf I_ModeloNF = "65" Then
         If Not IsNull(rsNF!ChaveNFCe) Or rsNF!ChaveNFCe = "" Then
            rsNFs!cNF = rsNF!ChaveNFCe                                                          ' Chave da NF
         Else
            rsNFs!cNF = FGerarChaveNF(iNumero, rsNF!DataEmissao, I_ModeloNF)                    ' Chave da NF
         End If
      End If

      rsNFs!natOp = IIf(Not rsNaturezasOperacao.EOF, rsNaturezasOperacao!Descricao, "VENDA")    ' Natureza Operação
      rsNFs!Mod = I_ModeloNF                                                                    ' Modelo (55 - NFe / 65 - NFCe)
      rsNFs!SERIE = "1"                                                                         ' Serie (1)
      rsNFs!nnf = iNumero                                                                       ' Número da Nota
      rsNFs!dhEmi = FDataNF(rsNF!DataEmissao, Time)                                             ' Data da Emissão [Gerar Padrão Horário de Verão]
      rsNFs!dhSaiEnt = FDataNF(rsNF!DataVencimento, Time)                                       ' Data da Saida [Gerar Padrão Horário de Verão]
      rsNFs!tpNF = IIf(rsCFOPs!Tipo = 0, NFE_TIPO_NF_ENTRADA, NFE_TIPO_NF_SAIDA)                ' Tipo de NF (0 - Entrada / 1 - Saida)
      rsNFs!idDest = IIf(Not Not rsClientes!Interestadual, "1", "2")                            ' Tipo de Destinatário (1. Operacao Interna / 2. Operacao Interestadual)
      rsNFs!cMunFG = I_EmpresaCodigoMunicipio                                                   ' Codigo do Municipio
      rsNFs!tpImp = IIf(I_ModeloNF = "55", "1", "4")                                            ' Formato do DANFe (1 - Emissão Retrato / 4 - DANFE NFC-e)
      rsNFs!tpEmis = "1"                                                                        ' Tipo de Emissao (1)
      rsNFs!cDV = Mid(rsNFs!cNF, 44, 1)                                                         ' Digito Verificador da Chave de Acesso
      rsNFs!tpAmb = LerArquivoINI("NFe", "Ambiente", CaminhoINI & "\System.ini")                ' Tipo de Ambiente (1 - Produção ou 2 - Homologação)
      rsNFs!finNFe = rsNaturezasOperacao!Tipo                                                   ' Finalidade (1 - NFe Normal / 2 - Complementar / 3 - Ajuste)
      rsNFs!indFinal = IIf(rsClientes!ConsumidorFinal, "1", "0")                                ' Consumidor (0 - Nao consumidor final / 1 - Consumidor final)
      rsNFs!indPres = "1"                                                                       ' Indicador de Presença (1 - Presencial)
      rsNFs!procEmi = "0"                                                                       ' Processo de emissão  (0 - Utilizando Software próprio)
      rsNFs!verProc = "SGC V2"                                                                  ' Versão do Aplicativo
      rsNFs.Update
   End If

   Set rsNF = Nothing
   Set rsNaturezasOperacao = Nothing
   Set rsCFOPs = Nothing
   Set rsClientes = Nothing
   
End Function

Public Function PreencherRsEmitentes()
Dim rsEmpresa As New ADODB.Recordset
Dim rsMunicipios As New ADODB.Recordset

   Set rsEmpresa = cnSistema.Execute("Select * From Empresa")
   Set rsMunicipios = cnSistema.Execute("Select * From Municipios WHERE idMunicipio=" & rsEmpresa!idMunicipio)
   
   rsNFsEmitentes.AddNew
   rsNFsEmitentes!nnf = iNumero                                                                                            ' Número da Nota
   rsNFsEmitentes!CNPJ = RemoveCaracteres(rsEmpresa!CNPJ_CPF)                                                              ' CNPJ
   rsNFsEmitentes!CPF = ""                                                                                                 ' CPF
   rsNFsEmitentes!xNome = rsEmpresa!Nome                                                                                   ' Nome
   rsNFsEmitentes!xFant = ""                                                                                               ' Nome Fantasia
   rsNFsEmitentes!xLgr = rsEmpresa!Endereco                                                                                ' Logradouro
   rsNFsEmitentes!nro = "."                                                                                                ' Numero
   rsNFsEmitentes!xBairro = rsEmpresa!Bairro                                                                               ' Bairro
   rsNFsEmitentes!cMun = RemoveCaracteres(rsMunicipios!Codigo)                                                             ' Codigo Municipio
   rsNFsEmitentes!xMun = rsMunicipios!Nome                                                                                 ' Nome Municipio
   rsNFsEmitentes!uf = rsMunicipios!uf                                                                                     ' UF
   rsNFsEmitentes!CEP = RemoveCaracteres(rsEmpresa!CEP)                                                                    ' CEP
   rsNFsEmitentes!cPais = "1058"                                                                                           ' Codigo do Pais
   rsNFsEmitentes!xPais = "BRASIL"                                                                                         ' Nome do Pais
   rsNFsEmitentes!fone = RemoveCaracteres(rsEmpresa!Telefone1)                                                             ' Telefone
   rsNFsEmitentes!IE = IIf(rsEmpresa!IE_CI <> "ISENTO", Trim(RemoveCaracteres(rsEmpresa!IE_CI)), "ISENTO")                 ' IE
   rsNFsEmitentes!CNAE = ""                                                                                                ' CNAE "5510803"
   rsNFsEmitentes!IM = ""                                                                                                  ' IM     (Analisar) IIf(rsEmpresa!IE_CI <> "ISENTO", Trim(RemoveCaracteres(rsEmpresa!IE_CI)), "ISENTO")
   rsNFsEmitentes!CRT = LerArquivoINI("NFe", "Regime", CaminhoINI & "\System.ini") ' 1 - Simples / 3 - Normal              ' CRT
   rsNFsEmitentes.Update

   Set rsEmpresa = Nothing
   Set rsMunicipios = Nothing

End Function

Public Function PreencherRsDestinatarios()
Dim rsClientes As New ADODB.Recordset
Dim rsLogradouros As New ADODB.Recordset
Dim rsMunicipios As New ADODB.Recordset

   If I_SGBD = "SQLSERVER" Then
      Set rsClientes = cnSistema.Execute("Select CN AS CNPJ_CPF, * From Clientes WHERE idCliente=" & rsNFs!idCliente)
   ElseIf I_SGBD = "ACCESS" Then
      Set rsClientes = cnSistema.Execute("Select * From Clientes WHERE idCliente=" & rsNFs!idCliente)
      Set rsLogradouros = cnSistema.Execute("Select * From Logradouros WHERE idLogradouro=" & rsClientes!idLogradouro)
   End If
   
   Set rsMunicipios = cnSistema.Execute("Select * From Municipios WHERE idMunicipio=" & rsClientes!idMunicipio)

   rsNFsDestinatarios.AddNew
   rsNFsDestinatarios!nnf = iNumero                                                                            ' Número da Nota
   If Not IsNull(rsClientes!CNPJ_CPF) Then
      If Len(RemoveCaracteres(rsClientes!CNPJ_CPF)) > 11 Then
         rsNFsDestinatarios!CNPJ = RemoveCaracteres(rsClientes!CNPJ_CPF)                                       ' CNPJ
      Else
         rsNFsDestinatarios!CPF = RemoveCaracteres(rsClientes!CNPJ_CPF)                                        ' CPF
      End If
   Else
      rsNFsDestinatarios!CNPJ = ""                                                                             ' CNPJ
      rsNFsDestinatarios!CPF = ""                                                                              ' CPF
   End If
   rsNFsDestinatarios!xNome = RemoveAcentos(IIf(Not IsNull(rsClientes!Nome), rsClientes!Nome, ""))             ' Nome
   
   If I_SGBD = "ACCESS" Then
      If Not rsLogradouros.EOF Then
         rsNFsDestinatarios!xLgr = IIf(Not rsLogradouros.EOF, IIf(rsLogradouros!Abreviacao <> ".", rsLogradouros!Abreviacao & " ", ""), "") & Trim(RemoveAcentos(rsClientes!Endereco))                        ' Logradouro
      Else
         rsNFsDestinatarios!xLgr = ""                                                                             ' Logradouro
      End If
      rsNFsDestinatarios!nro = Trim(IIf(Not IsNull(rsClientes!Numero), rsClientes!Numero, ""))                    ' Numero
      rsNFsDestinatarios!fone = StrZero(Val(IIf(Not IsNull(rsClientes!PrefixoFone1), rsClientes!PrefixoFone1, "0")), 2) & Trim(FormataTXT(RemoveCaracteres(IIf(Not IsNull(rsClientes!Telefone1), rsClientes!Telefone1, "0")), 1, 10))                        ' Telefone
   
      rsNFsDestinatarios!IE = IIf(IIf(Not IsNull(rsClientes!IE_CI), rsClientes!IE_CI, "ISENTO") <> "ISENTO", Trim(RemoveCaracteres(IIf(Not IsNull(rsClientes!IE_CI), rsClientes!IE_CI, ""))), "ISENTO")                            ' IE
   
      Select Case rsClientes!TipoContribuinte
             Case 0
                  rsNFsDestinatarios!indIEDest = 1 'Contribuinte do ICMS
             Case 1
                  rsNFsDestinatarios!indIEDest = 2 'Contribuinte isento de Incrição Estadual
             Case 2
                  rsNFsDestinatarios!indIEDest = 9 'Não contribuinte de Incrição Estadual
      End Select
   Else
      rsNFsDestinatarios!xLgr = ""                                                                             ' Logradouro
      rsNFsDestinatarios!nro = ""                                                                              ' Numero
      rsNFsDestinatarios!fone = Trim(FormataTXT(RemoveCaracteres(IIf(Not IsNull(rsClientes!Telefone_1), rsClientes!Telefone_1, "0")), 1, 10))                        ' Telefone
   
      rsNFsDestinatarios!IE = IIf(IIf(Not IsNull(rsClientes!CE), rsClientes!CE, "ISENTO") <> "ISENTO", Trim(RemoveCaracteres(IIf(Not IsNull(rsClientes!CE), rsClientes!CE, ""))), "ISENTO")                            ' IE
   
      Select Case rsClientes!idTipoContribuinte
             Case 0
                  rsNFsDestinatarios!indIEDest = 1 'Contribuinte do ICMS
             Case 1
                  rsNFsDestinatarios!indIEDest = 2 'Contribuinte isento de Incrição Estadual
             Case 2
                  rsNFsDestinatarios!indIEDest = 9 'Não contribuinte de Incrição Estadual
      End Select
   End If
   
   rsNFsDestinatarios!xBairro = RemoveAcentos(IIf(Not IsNull(rsClientes!Bairro), rsClientes!Bairro, "."))      ' Bairro
   rsNFsDestinatarios!cMun = Trim(RemoveAcentos(RemoveCaracteres(IIf(Not rsMunicipios.EOF, rsMunicipios!Codigo, ""))))  ' Codigo Municipio
   rsNFsDestinatarios!xMun = RemoveAcentos(IIf(Not rsMunicipios.EOF, rsMunicipios!Nome, ""))                            ' Nome Municipio
   rsNFsDestinatarios!uf = IIf(Not IsNull(rsClientes!uf), rsClientes!uf, "")                                                                     ' UF
   rsNFsDestinatarios!CEP = RemoveCaracteres(IIf(Not IsNull(rsClientes!CEP), rsClientes!CEP, ""))              ' CEP
   rsNFsDestinatarios!cPais = "1058"                                                                           ' Codigo do Pais
   rsNFsDestinatarios!xPais = "BRASIL"                                                                         ' Nome do Pais
   rsNFsDestinatarios.Update

   Set rsClientes = Nothing
   Set rsLogradouros = Nothing
   Set rsMunicipios = Nothing

End Function

Public Function PreencherRsItens(ByVal iNumero As Integer, ByVal sModeloNF As String)
Dim rsProdutos As New ADODB.Recordset
Dim rsUnidades As New ADODB.Recordset
Dim rsSituacoesTributarias As New ADODB.Recordset
Dim rsTributos As New ADODB.Recordset
Dim rsNF As New ADODB.Recordset
Dim rsNFItens As New ADODB.Recordset

Dim dBaseCalculo As Double

'''''Dim I_ModeloNF As String
Dim I_idNF As Integer

'''''   If sModeloNF = "55" Then
'''''      I_ModeloNF = "NFe"
'''''   ElseIf sModeloNF = "65" Then
'''''      I_ModeloNF = "NFCe"
'''''   End If
   
   Set rsNF = cnSistema.Execute("Select * From " & I_TabelasNF & " WHERE Numero=" & iNumero)
   If Not rsNF.EOF Then
      If I_ModeloNF = "55" Then
         I_idNF = rsNF!idNFe
      ElseIf I_ModeloNF = "65" Then
         I_idNF = rsNF!idNFCe
      End If
   
      ' Inserir Totais
      rsNFsTotaisICMS.AddNew
      rsNFsTotaisICMS!nnf = rsNF!Numero
      rsNFsTotaisICMS!vTotTrib = 0
      rsNFsTotaisICMS.Update

      rsNFsTotaisISS.AddNew
      rsNFsTotaisISS!nnf = rsNF!Numero
      rsNFsTotaisISS.Update

      ' Itens
      If I_SGBD = "ACCESS" Then
         Set rsNFItens = cnSistema.Execute("SELECT * FROM " & I_TabelasNF & "Itens WHERE " & I_TabelasNF & "Itens.id" & I_TabelasNF & " = " & I_idNF)
      Else
         Set rsNFItens = cnSistema.Execute("SELECT 0 as ISS, * FROM " & I_TabelasNF & "Itens WHERE " & I_TabelasNF & "Itens.id" & I_TabelasNF & " = " & I_idNF)
      End If
      Do While Not rsNFItens.EOF
         Set rsProdutos = cnSistema.Execute("SELECT * FROM Produtos WHERE idProduto = " & rsNFItens!IDProduto)
         Set rsNaturezasOperacao = cnSistema.Execute("Select * From NaturezasOperacao WHERE idNaturezaOperacao = " & rsNF!idNaturezaOperacao)
         If I_SGBD = "ACCESS" Then
            Set rsUnidades = cnSistema.Execute("Select * From UnidadesMedida WHERE idUnidadeMedida=" & rsProdutos!idUnidade)
         End If
         Set rsSituacoesTributarias = cnSistema.Execute("Select * from SituacoesTributarias WHERE idSituacaoTributaria=" & rsNFItens!idSituacaoTributaria)
         Set rsTributos = cnSistema.Execute("SELECT * FROM TabelaIBPT WHERE CodigoNCM LIKE '%" & rsProdutos!CodigoNCM & "%'")
      
         rsNFsItens.AddNew
         rsNFsItens!nnf = rsNF!Numero
         If I_SGBD = "ACCESS" Then
            rsNFsItens!uCom = IIf(Not rsUnidades.EOF, rsUnidades!Sigla, "UN")
            rsNFsItens!uTrib = IIf(Not rsUnidades.EOF, rsUnidades!Sigla, "UN")
            rsNFsItens!cProd = rsProdutos!Codigo
         Else
            rsNFsItens!uCom = rsProdutos!Unidade
            rsNFsItens!uTrib = rsProdutos!Unidade
            rsNFsItens!cProd = IIf(Trim(rsProdutos!CodigoBarra) <> "", rsProdutos!CodigoBarra, StrZero(Val(rsProdutos!IDProduto), 5))
         End If
         
         rsNFsItens!cEAN = "SEM GTIN"
         rsNFsItens!xProd = IIf(rsNFItens!DiscriminacaoProduto = "", RemoveAcentos(rsProdutos!Descricao), RemoveAcentos(rsNFItens!DiscriminacaoProduto))
         If Not IsNull(rsNFItens!DescricaoComplementar) Then
            If Trim(rsNFItens!DescricaoComplementar) <> "" Then
               rsNFsItens!xProd = rsNFsItens!xProd & " " & RemoveAcentos(rsNFItens!DescricaoComplementar)
             End If
         End If
         rsNFsItens!NCM = IIf(rsProdutos!CodigoNCM = "" Or IsNull(rsProdutos!CodigoNCM), "", rsProdutos!CodigoNCM)
         rsNFsItens!CFOP = RemoveCaracteres(rsNFItens!CFOP)
         rsNFsItens!qCom = Substitui(Format(rsNFItens!quantidade, "#######0.0000"), ",", ".")
         rsNFsItens!vUnCom = Substitui(Format(rsNFItens!ValorUnitario, "#######0.00"), ",", ".")
         rsNFsItens!vProd = Substitui(Format(rsNFItens!quantidade * rsNFItens!ValorUnitario, "#######0.00"), ",", ".")
         rsNFsItens!cEANTrib = "SEM GTIN"
         rsNFsItens!qTrib = Substitui(Format(rsNFItens!quantidade, "#######0.0000"), ",", ".")
         rsNFsItens!vUnTrib = Substitui(Format(rsNFItens!ValorUnitario, "#######0.00"), ",", ".")
         rsNFsItens!indTot = "1"
         
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
         rsNFsItens!AliqICMS = rsNFItens!ICMS
         rsNFsItens!AliqISS = rsNFItens!ISS
         
         rsNFsItens!Desconto = rsNFItens!Desconto
         rsNFsItens!ValorFrete = rsNFItens!ValorFrete
         
         
         If Not rsTributos.EOF Then
            rsNFsTotaisICMS!vTotTrib = rsNFsTotaisICMS!vTotTrib + (((rsNFsItens!qTrib * rsNFsItens!vUnTrib) * rsTributos!AliquotaNacional) / 100)
         End If
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
 
         Dim sCST As String
         sCST = Mid(rsSituacoesTributarias!Codigo, 1, 3)
      
         If rsNFsItens!AliqISS <= 0 Then
            If rsNFsItens!AliqICMS > 0 Then
               dBaseCalculo = (rsNFsItens!qTrib * rsNFsItens!vUnTrib) - (((rsNFsItens!qTrib * rsNFsItens!vUnTrib) * rsNFsItens!Desconto) / 100)
            Else
               dCalculoBC = 0
            End If
         
''            Dim Nx As String
            Select Case sCST
                   Case "000" ' Tributada Integralmente
''                        If rsNFCeItens!ICMS > 0 Then
''                           dBaseCalculo = (rsNFCeItens!quantidade * rsNFCeItens!ValorUnitario) - (((rsNFCeItens!quantidade * rsNFCeItens!ValorUnitario) * rsNFCeItens!Desconto) / 100)
''
''                           sCST = "00"
''                           sOrigem = "0"
''                           sModalidadeBC = "3"
''                           sValorBC = Substitui(Format(dCalculoBC, "#######0.00"), ",", ".")
''                           sICMS = Substitui(Format(rsNFCeItens!ICMS, "###0.00"), ",", ".")
''                           sValorICMS = Substitui(Format(((dCalculoBC * rsNFCeItens!ICMS) / 100), "#######0.00"), ",", ".")
''                        Else
''                           dCalculoBC = 0
''
''                           sCST = "00"
''                           sOrigem = "0"
''                           sModalidadeBC = "3"
''                           sValorBC = Substitui(Format(0, "#######0.00"), ",", ".")
''                           sICMS = Substitui(Format(0, "###0.00"), ",", ".")
''                           sValorICMS = Substitui(Format(0, "#######0.00"), ",", ".")
''                        End If
''
''                        Print #1, "N02|" & _
''                                  sOrigem & "|" & _
''                                  sCST & "|" & _
''                                  sModalidadeBC & "|" & _
''                                  sValorBC & "|" & _
''                                  sICMS & "|" & _
''                                  sValorICMS & "|"
   
                   Case "010"
                        dCalculoBC = 0
''                        Nx = "03"
                   Case "020"
''                        dCalculoBC = Round(((((rsNFCeItens!quantidade * rsNFCeItens!ValorUnitario) - (((rsNFCeItens!quantidade * rsNFCeItens!ValorUnitario) * rsNFCeItens!Desconto) / 100)) * rsNFCeItens!BaseReduzida) / 100), 2)
''
''                        sCST = "20"
''                        sOrigem = "0"
''                        sModalidadeBC = "3"
''                        sPercRedBC = Substitui(Format(rsNFCeItens!BaseReduzida, "#########0.00"), ",", ".")
''                        sValorBC = Substitui(Format(dCalculoBC, "#######0.00"), ",", ".")
''                        sICMS = Substitui(Format(rsNFCeItens!ICMS, "###0.00"), ",", ".")
''                        sValorICMS = Substitui(Format(((dCalculoBC * rsNFCeItens!ICMS) / 100), "#######0.00"), ",", ".")
''
''                        Print #1, "N04|" & _
''                                  sOrigem & "|" & _
''                                  sCST & "|" & _
''                                  sModalidadeBC & "|" & _
''                                  sPercRedBC & "|" & _
''                                  sValorBC & "|" & _
''                                  sICMS & "|" & _
''                                  sValorICMS
   
                   Case "030"
''                        Nx = "05"
                        dCalculoBC = 0
                   Case "040"
''                        Nx = "06"
                        dCalculoBC = 0
                   Case "051"
''                        Nx = "07"
                        dCalculoBC = 0
                   Case "060"
''                        Nx = "08"
                        dCalculoBC = 0
                   Case "070"
''                        Nx = "09"
                        dCalculoBC = 0
                   Case "090"
''                        Nx = "10"
                        dCalculoBC = 0
            
                   Case "101" ' Tributada com permissão de crédito
                        ' Criar o preenchimento de Autorização de percentual de ICMS
                        dCalculoBC = 0
                        
                        rsNFsItens!orig = "0"
                        rsNFsItens!CSOSN = sCST
                        rsNFsItens!pCredSN = 0
                        rsNFsItens!vCredICMSSN = 0
   
                   Case "102" ' Tributada pelo Simples Nacional sem permissão de crédito.
                   ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
                        dCalculoBC = 0
                        
                        rsNFsItens!orig = "0"
                        rsNFsItens!CSOSN = sCST
                        
                   Case "103" ' Isenção do ICMS no Simples Nacional para faixa de receita bruta.
                   ''''''''''''''''''''''''''''''''''''
                        dCalculoBC = 0
                        
                        rsNFsItens!orig = "0"
                        rsNFsItens!CSOSN = sCST
                                  
                   Case "300" ' Imune
                   ''''''''''''''''''''''''''''''''''''
                        dCalculoBC = 0
                        
                        rsNFsItens!orig = "0"
                        rsNFsItens!CSOSN = sCST
                                  
                   Case "400" ' Não tributada
                   ''''''''''''''''''''''''''''''''''''
                        dCalculoBC = 0
                        
                        rsNFsItens!orig = "0"
                        rsNFsItens!CSOSN = sCST
                                  
                   Case "202" ' Tributada sem permissão de crédito com Substituição Tributaria
                   ''''''''''''''''''''''''''''''''''''
                        dCalculoBC = 0
                        
                        rsNFsItens!orig = "0"
                        rsNFsItens!CSOSN = sCST
                        rsNFsItens!modBCST = "0"
                        rsNFsItens!vBCSTRet = 0
                        rsNFsItens!pMVAST = 0
                        rsNFsItens!pRedBCST = 0
                        rsNFsItens!vBCST = 0
                        rsNFsItens!pICMSST = 0
                        rsNFsItens!vICMSST = 0
                        rsNFsItens!pFCPST = 0
                        rsNFsItens!vFCPST = 0
            
                   Case "500" ' Substituição Tributaria
                   ''''''''''''''''''''''''''''''''''''
                        dCalculoBC = 0
                        
                        rsNFsItens!orig = "0"
                        rsNFsItens!CSOSN = sCST
                        rsNFsItens!vBCSTRet = 0
                        rsNFsItens!vICMSSTRet = 0
            
                   Case "900" ' Outros
                   ''''''''''''''''''''''''''''''''''''
                        dCalculoBC = 0
                        
                        rsNFsItens!orig = "0"
                        rsNFsItens!CSOSN = sCST
                        rsNFsItens!vBCSTRet = 0
                        rsNFsItens!vICMSSTRet = 0
            
            End Select
         
         End If

       ' Totalizar
         If rsNaturezasOperacao!Descricao <> "COMPLEMENTO DE VALOR" Then
            If rsNFsItens!AliqISS <= 0 Then
'''''            If rsNFsItens!ISS <= 0 Then
               rsNFsTotaisICMS!vBC = rsNFsTotaisICMS!vBC + dBaseCalculo
               rsNFsTotaisICMS!vICMS = rsNFsTotaisICMS!vICMS + ((dBaseCalculo * rsNFsItens!AliqICMS) / 100)
            End If
            rsNFsTotaisICMS!vProd = rsNFsTotaisICMS!vProd + (rsNFsItens!qTrib * rsNFsItens!vUnTrib)
            rsNFsTotaisICMS!vDesc = rsNFsTotaisICMS!vDesc + (((rsNFsItens!qTrib * rsNFsItens!vUnTrib) * rsNFsItens!Desconto) / 100)
            rsNFsTotaisICMS!vFrete = rsNFsTotaisICMS!vFrete + rsNFsItens!ValorFrete
            rsNFsTotaisICMS!vNF = rsNFsTotaisICMS!vNF + (rsNFsItens!qTrib * rsNFsItens!vUnTrib) + rsNFsItens!ValorFrete
         Else
            If rsNFsItens!AliqISS <= 0 Then
'''''            If rsNFsItens!ISS <= 0 Then
               rsNFsTotaisICMS!vBC = rsNFsTotaisICMS!vBC + dBaseCalculo
               rsNFsTotaisICMS!vICMS = rsNFsTotaisICMS!vICMS + ((dBaseCalculo * rsNFsItens!AliqICMS) / 100)
            End If
            rsNFsTotaisICMS!vProd = 0
            rsNFsTotaisICMS!vDesc = 0
            rsNFsTotaisICMS!vFrete = rsNFsTotaisICMS!vFrete + rsNFsItens!ValorFrete
            rsNFsTotaisICMS!vNF = 0
         End If
         
         rsNFsTotaisICMS.Update

         ' Grupo U
         If I_SGBD = "ACCESS" Then
            If rsNFsItens!AliqISS <= 0 Then
   '''''         If rsNFCeItens!ISS > 0 Then
   '''''            Dim vAliqISS As String
   '''''            Dim vISSQN As String
   '''''            Dim cMunFG As String
   '''''            Dim cListServ As String
   '''''            Dim vDeducao As String
   '''''            Dim vOutro As String
   '''''            Dim vDescIncond As String
   '''''            Dim vDescCond As String
   '''''            Dim vISSRet As String
   '''''            Dim indISS As String
   '''''            Dim cServico As String
   '''''            Dim cMun As String
   '''''            Dim cPais As String
   '''''            Dim nProcesso As String
   '''''            Dim indIncentivo As String
            
'''''               rsNFsTotaisISS!vBC = rsNFsTotaisISS!vBC + (rsNFCeItens!quantidade * rsNFCeItens!ValorUnitario)

               ' ISS por Item
               rsNFsItens!vBCISS = (rsNFsItens!qTrib * rsNFsItens!vUnTrib)
               rsNFsItens!vAliqISS = rsNFsItens!ISS
               rsNFsItens!vISSQN = (((rsNFsItens!qTrib * rsNFsItens!vUnTrib) * rsNFsItens!ISS) / 100)
               rsNFsItens!cMunFGISS = I_EmpresaCodigoMunicipio
               rsNFsItens!cListServISS = "09.01"
               rsNFsItens!indIncentivoISS = "2"
               
               ' Totais ISS
               rsNFsTotaisISS!vServ = rsNFsTotaisISS!vBC + (rsNFsItens!qTrib * rsNFsItens!vUnTrib)
               rsNFsTotaisISS!vBC = rsNFsTotaisISS!vBC + (rsNFsItens!qTrib * rsNFsItens!vUnTrib)
               rsNFsTotaisISS!vISS = rsNFsTotaisISS!vISS + (((rsNFsItens!qTrib * rsNFsItens!vUnTrib) * rsNFsItens!ISS) / 100)
               rsNFsTotaisISS!dCompet = Format(rsNFs!DataEmissao, "YYYY-MM-DD")
               rsNFsTotaisISS!cRegTrib = "1"
                              
               
'''''               vBC = Substitui(Format(rsNFCeItens!quantidade * rsNFCeItens!ValorUnitario, "#######0.00"), ",", ".")
'''''               vAliqISS = Substitui(Format(rsNFCeItens!ISS, "#######0.00"), ",", ".")
'''''               vISSQN = Substitui(Format((((rsNFCeItens!quantidade * rsNFCeItens!ValorUnitario) * rsNFCeItens!ISS) / 100), "#######0.00"), ",", ".")
'''''               Set rsTemp = cnSistema.Execute("Select * From Municipios WHERE idMunicipio=" & rsEmpresa!idMunicipio)
'''''               cMunFG = RemoveCaracteres(rsTemp!Codigo)
'''''               cListServ = "09.01"
'''''               vDeducao = ""
'''''               vOutro = ""
'''''               vDescIncond = ""
'''''               vDescCond = ""
'''''               vISSRet = ""
'''''               indISS = "1"
'''''               cServico = ""
'''''               cMun = ""
'''''               cPais = ""
'''''               nProcesso = ""
'''''               indIncentivo = "2"
'''''
'''''               dValorTotalBaseISS = dValorTotalBaseISS + (rsNFCeItens!quantidade * rsNFCeItens!ValorUnitario)
'''''               dValorTotalISS = dValorTotalISS + (((rsNFCeItens!quantidade * rsNFCeItens!ValorUnitario) * rsNFCeItens!ISS) / 100)
               
   '''''            Print #1, Space(10) & "<ISSQN>"
   '''''            Print #1, Space(12) & FTAG("vBC", vBC)
   '''''            Print #1, Space(12) & FTAG("vAliq", vAliqISS)
   '''''            Print #1, Space(12) & FTAG("vISSQN", vISSQN)
   '''''            Print #1, Space(12) & FTAG("cMunFG", cMunFG)
   '''''            Print #1, Space(12) & FTAG("cListServ", cListServ)
   '''''            Print #1, Space(12) & FTAG("indISS", indISS)
   '''''            Print #1, Space(12) & FTAG("indIncentivo", indIncentivo)
   '''''            Print #1, Space(10) & "</ISSQN>"
               
      '''         Print #1, "U|" & _
      '''                   vBC & "|" & _
      '''                   vAliqISS & "|" & _
      '''                   vISSQN & "|" & _
      '''                   cMunFG & "|" & _
      '''                   cListServ & "|" & _
      '''                   vDeducao & "|" & _
      '''                   vOutro & "|" & _
      '''                   vDescIncond & "|" & _
      '''                   vDescCond & "|" & _
      '''                   vISSRet & "|" & _
      '''                   indISS & "|" & _
      '''                   cServico & "|" & _
      '''                   cMun & "|" & _
      '''                   cPais & "|" & _
      '''                   nProcesso & "|" & _
      '''                   indIncentivo
            End If
         End If
         
         ' PIS / COFINS
         rsNFsItens!PIS = "07"                     ' Isento
         rsNFsItens!COFINS = "07"                  ' Isento
         
'''       ' PIS
'''         Print #1, Space(8) & "<PIS>"
'''         Print #1, Space(10) & "<PISOutr>"
'''         Print #1, Space(12) & FTAG("CST", "99")
'''         Print #1, Space(12) & FTAG("vBC", "0.00")
'''         Print #1, Space(12) & FTAG("pPIS", "0.00")
'''         Print #1, Space(12) & FTAG("vPIS", "0.00")
'''         Print #1, Space(10) & "</PISOutr>"
'''         Print #1, Space(8) & "</PIS>"
'''
'''       ' Cofins
'''         Print #1, Space(8) & "<COFINS>"
'''         Print #1, Space(10) & "<COFINSOutr>"
'''         Print #1, Space(12) & FTAG("CST", "99")
'''         Print #1, Space(12) & FTAG("vBC", "0.00")
'''         Print #1, Space(12) & FTAG("pCOFINS", "0.00")
'''         Print #1, Space(12) & FTAG("vCOFINS", "0.00")
'''         Print #1, Space(10) & "</COFINSOutr>"
'''         Print #1, Space(8) & "</COFINS>"

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

         rsNFsItens.Update
         
         rsNFItens.MoveNext
      Loop
   End If

   Set rsProdutos = Nothing
   Set rsUnidades = Nothing
   Set rsSituacoesTributarias = Nothing
   Set rsTributos = Nothing
   Set rsNF = Nothing
   Set rsNFItens = Nothing

End Function

Public Function PreencherRsFormasPagamento(ByVal iNumero As Integer)
'''''Dim rsNFCe As New ADODB.Recordset
Dim rsFormasPagamento As New ADODB.Recordset
'''''Dim rsNFCePagamentos As New ADODB.Recordset
'''''Dim sFormaPagamento As String
''''''   Set rsNFCe = cnSistema.Execute("Select * From NFCe WHERE Numero=" & NFCeNumero)
'''''   Set rsNFCe = cnSistema.Execute("Select * From NFCe WHERE Numero=" & iNumero)
'''''   Set rsFormasPagamento = cnSistema.Execute("Select * From " & I_TabelasNF & "Pagamentos WHERE id" & I_TabelasNF & "=" & rsNFs!idFormaPagamento)
'''''   Set rsNFCePagamentos = cnSistema.Execute("Select * From NFCePagamentos WHERE idNFCe=" & rsNFCe!idNFCe)
Dim rsNF As New ADODB.Recordset
Dim rsNFItens As New ADODB.Recordset

'''''Dim I_ModeloNF As String
Dim I_idNF As Integer

'''''   If sModeloNF = "55" Then
'''''      I_ModeloNF = "NFe"
'''''   ElseIf sModeloNF = "65" Then
'''''      I_ModeloNF = "NFCe"
'''''   End If
   
   Set rsNF = cnSistema.Execute("Select * From " & I_TabelasNF & " WHERE Numero=" & iNumero)

   If I_ModeloNF = "55" Then
      I_idNF = rsNF!idNFe
   ElseIf I_ModeloNF = "65" Then
      I_idNF = rsNF!idNFCe
   End If

   If I_SGBD = "ACCESS" Then
      Set rsFormasPagamento = cnSistema.Execute("SELECT * FROM " & I_TabelasNF & "Pagamentos WHERE " & I_TabelasNF & "Pagamentos.id" & I_TabelasNF & " = " & I_idNF)
      Do While Not rsFormasPagamento.EOF
         '01=Dinheiro
         '02=Cheque
         '03=Cartão de Crédito
         '04=Cartão de Débito
         '05=Crédito Loja
         '10=Vale Alimentação
         '11=Vale Refeição
         '12=Vale Presente
         '13=Vale Combustível
         '99=Outros
   
         rsNFsPagamentos.AddNew
         rsNFsPagamentos!nnf = rsNF!Numero
         rsNFsPagamentos!tPag = StrZero(rsFormasPagamento!idFormaPagamento, 2)
         rsNFsPagamentos!vPag = Substitui(Format(rsFormasPagamento!Valor, "#######0.00"), ",", ".")
         rsNFsPagamentos.Update
   
         rsFormasPagamento.MoveNext
      Loop
   Else
   
      ' Informações de Pagamento
      Dim sdetPag As String
      Dim stPag As String
      Dim svPag As String
      
      sdetPag = "0"
      
      If sFinalidade = "4" Then     ' Devolução
         stPag = "90"   'Sem Pagamennto
         svPag = Substitui(Format(0, "#########0.00"), ",", ".")
      Else
         stPag = "01"   'Dinheiro
         svPag = Substitui(Format(rsNFsTotaisICMS!vNF, "#########0.00"), ",", ".")
      End If
   
      rsNFsPagamentos.AddNew
      rsNFsPagamentos!nnf = iNumero
      rsNFsPagamentos!tPag = stPag
      rsNFsPagamentos!vPag = svPag
      rsNFsPagamentos.Update
   End If
   
   Set rsFormasPagamento = Nothing
   
   
''''   If Not rsFormasPagamento.EOF Then
''''      If rsFormasPagamento!TipoPagamento <= 1 Then
''''         sFormaPagamento = "00"
''''      Else
''''         sFormaPagamento = "01"
''''      End If
''''   Else
''''      sFormaPagamento = "00"
''''   End If

   '01=Dinheiro
   '02=Cheque
   '03=Cartão de Crédito
   '04=Cartão de Débito
   '05=Crédito Loja
   '10=Vale Alimentação
   '11=Vale Refeição
   '12=Vale Presente
   '13=Vale Combustível
   '99=Outros

''''   sFormaPagamento = "01"
''''
''''   Print #1, Space(4) & "<pag>"
''''''   Print #1, Space(6) & "<detPag>"
''''   Print #1, Space(8) & FTAG("tPag", sFormaPagamento)
''''   Print #1, Space(8) & FTAG("vPag", Substitui(Format(dValorTotalNFCe, "#########0.00"), ",", "."))
''''''   Print #1, Space(6) & "</detPag>"
''''   Print #1, Space(4) & "</pag>"
   
   ' Limpar Recordsets
'''''   Set rsNFCe = Nothing
'''''   Set rsFormasPagamento = Nothing
'''''   Set rsNFCePagamentos = Nothing
''''''   Set sFormaPagamento = Nothing

End Function

Public Function PreencherRsTotais(ByVal iNumero As Integer)
Dim rsNFCe As New ADODB.Recordset

   ' Totais
'   Print #1, "W"
   
   Dim sValorTotalBC As String
   Dim sValorTotalICMS As String
   Dim sValorTotalBaseDeson As String
   Dim sValorTotalBCST As String
   Dim sValorTotalICMSST As String
   Dim sValorTotalProdutos As String
   Dim sValorTotalFrete As String
   Dim sValorTotalSeguro As String
   Dim sValorTotalDesconto As String
   Dim sValorTotalII As String
   Dim sValorTotalIPI As String
   Dim sValorTotalPIS As String
   Dim sValorTotalCofins As String
   Dim sValorTotalOutro As String
   Dim sValorTotalNFe As String
   Dim sRNTC As String
   Dim sValorTotalTrib As String
''   Dim sValorTotalNFCe As String
''   Dim sValorTotalICMSNFCe As String
   
   Dim sValorTotalBaseISS As String
   Dim sValorTotalISS As String
   
   Set rsNFCe = cnSistema.Execute("Select * From NFCe WHERE Numero=" & iNumero)
   
   sValorTotalBC = Substitui(Format(dValorTotalBC, "#########0.00"), ",", ".")
   sValorTotalICMS = Substitui(Format(dValorTotalICMS, "#########0.00"), ",", ".")
   sValorTotalBaseDeson = Substitui(Format(0, "#########0.00"), ",", ".")
   sValorTotalBCST = Substitui(Format(0, "#########0.00"), ",", ".")
   sValorTotalICMSST = Substitui(Format(0, "#########0.00"), ",", ".")
   sValorTotalProdutos = Substitui(Format((dValorTotalProdutos - dValorTotalBaseISS), "#########0.00"), ",", ".")
   sValorTotalFrete = Substitui(Format(dValorTotalFrete, "#########0.00"), ",", ".")
   sValorTotalSeguro = Substitui(Format(0, "#########0.00"), ",", ".")
   sValorTotalDesconto = Substitui(Format(dValorTotalDesconto, "#########0.00"), ",", ".")
   sValorTotalII = Substitui(Format(0, "#########0.00"), ",", ".")
   sValorTotalIPI = Substitui(Format(0, "#########0.00"), ",", ".")
   sValorTotalPIS = Substitui(Format(0, "#########0.00"), ",", ".")
   sValorTotalCofins = Substitui(Format(0, "#########0.00"), ",", ".")
   sValorTotalOutro = Substitui(Format(0, "#########0.00"), ",", ".")
   sValorTotalNFe = Substitui(Format(dValorTotalNFCe, "#########0.00"), ",", ".")
   sValorTotalTrib = Substitui(Format(0, "#########0.00"), ",", ".")
   
   sValorTotalNFCe = Substitui(Format(dValorTotalNFCe, "#########0.00"), ",", ".")
   sValorTotalICMSNFCe = Substitui(Format(dValorTotalICMS, "#########0.00"), ",", ".")
   
   sValorTotalBaseISS = Substitui(Format(dValorTotalBaseISS, "#########0.00"), ",", ".")
   sValorTotalISS = Substitui(Format(dValorTotalISS, "#########0.00"), ",", ".")
   
   ' Totalização do ICMS
   Print #1, Space(4) & "<total>"
   Print #1, Space(6) & "<ICMSTot>"

   Print #1, Space(8) & FTAG("vBC", sValorTotalBC)
   Print #1, Space(8) & FTAG("vICMS", sValorTotalICMS)
   Print #1, Space(8) & FTAG("vICMSDeson", sValorTotalBaseDeson)
''''   Print #1, Space(8) & FTAG("vFCP", "0.00")
   Print #1, Space(8) & FTAG("vFCPUFDest", "0.00")
   Print #1, Space(8) & FTAG("vBCST", sValorTotalBCST)
   Print #1, Space(8) & FTAG("vST", sValorTotalICMSST)
''''   Print #1, Space(8) & FTAG("vFCPST", "0.00")
''''   Print #1, Space(8) & FTAG("vFCPSTRet", "0.00")
   Print #1, Space(8) & FTAG("vProd", sValorTotalProdutos)
   Print #1, Space(8) & FTAG("vFrete", sValorTotalFrete)
   Print #1, Space(8) & FTAG("vSeg", sValorTotalSeguro)
   Print #1, Space(8) & FTAG("vDesc", sValorTotalDesconto)
   Print #1, Space(8) & FTAG("vII", sValorTotalII)
   Print #1, Space(8) & FTAG("vIPI", sValorTotalIPI)
''''   Print #1, Space(8) & FTAG("vIPIDevol", "0.00")
   Print #1, Space(8) & FTAG("vPIS", sValorTotalPIS)
   Print #1, Space(8) & FTAG("vCOFINS", sValorTotalCofins)
   Print #1, Space(8) & FTAG("vOutro", sValorTotalOutro)
   Print #1, Space(8) & FTAG("vNF", sValorTotalNFe)
''''   Print #1, Space(8) & FTAG("vTotTrib", sValorTotalTrib)
   
'   Print #1, "W02|" & _
'             sValorTotalBC & "|" & _
'             sValorTotalICMS & "|" & _
'             sValorTotalBaseDeson & "|" & _
'             sValorTotalBCST & "|" & _
'             sValorTotalICMSST & "|" & _
'             sValorTotalProdutos & "|" & _
'             sValorTotalFrete & "|" & _
'             sValorTotalSeguro & "|" & _
'             sValorTotalDesconto & "|" & _
'             sValorTotalII & "|" & _
'             sValorTotalIPI & "|" & _
'             sValorTotalPIS & "|" & _
'             sValorTotalCofins & "|" & _
'             sValorTotalOutro & "|" & _
'             sValorTotalNFe & "|" & _
'             sValorTotalTrib
   
   Print #1, Space(6) & "</ICMSTot>"
   
   ' Totalização do ISS
   If dValorTotalBaseISS > 0 Then
      Print #1, Space(6) & "<ISSQNtot>"
      Print #1, Space(8) & FTAG("vServ", sValorTotalBaseISS)
      Print #1, Space(8) & FTAG("vBC", sValorTotalBaseISS)
      Print #1, Space(8) & FTAG("vISS", sValorTotalISS)
      Print #1, Space(8) & FTAG("dCompet", Format(rsNFCe!DataEmissao, "YYYY-MM-DD"))
      Print #1, Space(8) & FTAG("cRegTrib", "1")
      Print #1, Space(6) & "</ISSQNtot>"
   End If
   
   Print #1, Space(4) & "</total>"
End Function


Private Function FDataNF(sData As String, sHora As String) As String
On Error GoTo Erro

   FDataNF = Format(sData, "YYYY-MM-DD") & "T" & Format(sHora, "HH:MM:SS") & IIf(I_HorarioVerao, "-02:00", "-03:00")

   Exit Function
Erro:
   MsgBox "Erro " & Err & ". " & Err.Description & " - " & TypeName(Me) & ".FDataNF"
End Function

Private Function FGerarChaveNF(iNumero As Integer, dDataEmissao As Date, sModelo As String) As String
On Error GoTo Erro
   
   ' Define uma chave randomica para a nota
   Randomize
   Dim dNumRandomico As Double
   Dim sNumRandomico As String
   
   dNumRandomico = Int(Rnd * 99999999) + 1
   sNumRandomico = StrZero(dNumRandomico, 8)
   
   ' Montar chave da NF-e
   Dim chNFecUF As String
   Dim chNFeAAMM As String
   Dim chNFeCNPJ As String
   Dim chNFemod As String
   Dim chNFeserie As String
   Dim chNFenNF As String
   Dim chNFetpEmis As String
   Dim chNFecNF As String
   Dim chNFecDV As String
   
   chNFecUF = I_EmpresaCodigoUF
   chNFeAAMM = Format(dDataEmissao, "YYMM")
   chNFeCNPJ = RemoveCaracteres(I_Empresa_CNPJ_CPF)
   chNFemod = sModelo
   chNFeserie = "001"
   chNFenNF = StrZero(iNumero, 9)
   chNFetpEmis = "1"                ''sTipoEmissao
   chNFecNF = sNumRandomico
   chNFecDV = Calculo_DV11(chNFecUF & chNFeAAMM & chNFeCNPJ & chNFemod & chNFeserie & chNFenNF & chNFetpEmis & chNFecNF)
      
   FGerarChaveNF = chNFecUF & chNFeAAMM & chNFeCNPJ & chNFemod & chNFeserie & chNFenNF & chNFetpEmis & chNFecNF & chNFecDV

   Exit Function
Erro:
   MsgBox "Erro " & Err & ". " & Err.Description & " - " & TypeName(Me) & ".FGerarChaveNF"
End Function









''''Public Function CriaEstruturaPlanoPagamento(ByVal dtDataLiberacao As Date, _
''''                                            ByVal iPeriodicidadeCarencia As Integer, _
''''                                            ByVal iQtdCarencia As Integer, _
''''                                            ByVal iPeriodicidadeAmortizacao As Integer, _
''''                                            ByVal iQtdAmortizacao As Integer, _
''''                                            ByVal bEncExigiveisCarencia As Boolean, _
''''                                            ByVal cValorSaldoDevedor As Currency, _
''''                                            ByVal dblPercTaxaJuros As Double, _
''''                                            ByVal dblSpreadBancoob As Double) As ADODB.Recordset
''''On Error GoTo l_Error
''''
''''
''''    Dim rsPlanoPagamento As New ADODB.Recordset
''''    Dim iCt              As Integer
''''    Dim dtDataInicio     As Date
''''    Dim dtDataFim        As Date
''''    Dim dtDataVencimento As Date
''''    Dim dtUltimoCalculo  As Date
''''    Dim CValorAmortizacao   As Currency
''''    Dim CValorSaldoRestante As Currency
''''    Dim dblPropSpreadBB     As Double
''''
''''    With rsPlanoPagamento
''''
''''        .Fields.Append "DataLiberacao", adDate, 4
''''        .Fields.Append "NumParcela", adSmallInt, 5
''''        .Fields.Append "CodTipoParcela", adTinyInt, 3
''''        .Fields.Append "TipoParcela", adVarChar, 20
''''        .Fields.Append "QtdDiasParcela", adInteger
''''        .Fields.Append "DataVencParcela", adDate, 4
''''        .Fields.Append "PercTaxaJuros", adDouble, 8
''''        .Fields.Append "ValorParcela", adCurrency, 19
''''        .Fields.Append "CodSituacaoParcela", adTinyInt, 3
''''        .Fields.Append "ValorJurosParcela", adCurrency, 19
''''        .Fields.Append "ValorAmortizacaoParcela", adCurrency, 19
''''        .Fields.Append "SaldoDevedorParaCalculo", adCurrency, 19
''''        .Fields.Refresh
''''        .Open
''''
''''    End With
''''
''''    dtUltimoCalculo = PrimeiroDiaProximoMes(dtDataLiberacao)
''''
''''    dblPropSpreadBB = 1 - dblSpreadBancoob / dblPercTaxaJuros
''''
''''    iCt = 1
''''
''''    dtDataInicio = dtDataLiberacao
''''
''''    If bEncExigiveisCarencia Then
''''
''''        dtDataVencimento = RetornaDataVencimento(iPeriodicidadeCarencia, dtUltimoCalculo, 1)
''''
''''        dtDataFim = RetornaDataVencimento(iPeriodicidadeCarencia, dtDataVencimento, iQtdCarencia - 1)
''''
''''        Do While dtDataVencimento <= dtDataFim
''''
''''            rsPlanoPagamento.AddNew
''''            rsPlanoPagamento!NumParcela = iCt
''''            rsPlanoPagamento!DataVencParcela = dtDataVencimento
''''            rsPlanoPagamento!ValorJurosParcela = RetornoCalculoJurosFCO(dtDataInicio, dtDataVencimento, dblPercTaxaJuros, cValorSaldoDevedor, dblPropSpreadBB)
''''            rsPlanoPagamento!ValorAmortizacaoParcela = 0#
''''            rsPlanoPagamento!ValorParcela = rsPlanoPagamento!ValorJurosParcela
''''            rsPlanoPagamento!SaldoDevedorParaCalculo = cValorSaldoDevedor
''''            rsPlanoPagamento!CodSituacaoParcela = COD_SIT_PARC_NORMAL
''''            rsPlanoPagamento!QtdDiasParcela = DateDiff("d", dtDataInicio, dtDataVencimento)
''''            rsPlanoPagamento!CodTipoParcela = COD_TIPO_PARCELA_CARENCIA
''''            rsPlanoPagamento!TipoParcela = "Carência"
''''            rsPlanoPagamento!PercTaxaJuros = dblPercTaxaJuros
''''            rsPlanoPagamento!DataLiberacao = dtDataLiberacao
''''
''''            rsPlanoPagamento.Update
''''
''''            dtDataInicio = dtDataVencimento
''''
''''            If dtDataVencimento = dtDataFim Then
''''                dtDataVencimento = RetornaDataVencimento(iPeriodicidadeAmortizacao, dtDataInicio, 1)
''''            Else
''''                dtDataVencimento = RetornaDataVencimento(iPeriodicidadeCarencia, dtDataInicio, 1)
''''            End If
''''
''''            iCt = iCt + 1
''''        Loop
''''    Else
''''        dtDataFim = RetornaDataVencimento(iPeriodicidadeCarencia, dtUltimoCalculo, iQtdCarencia)
''''        dtDataVencimento = RetornaDataVencimento(iPeriodicidadeAmortizacao, dtDataFim, 1)
''''    End If
''''
''''    CValorAmortizacao = Round(cValorSaldoDevedor / iQtdAmortizacao, 2)
''''    CValorSaldoRestante = cValorSaldoDevedor
''''
''''    dtDataFim = RetornaDataVencimento(iPeriodicidadeAmortizacao, dtDataFim, iQtdAmortizacao)
''''
''''    Do While dtDataVencimento <= dtDataFim
''''
''''        rsPlanoPagamento.AddNew
''''        rsPlanoPagamento!NumParcela = iCt
''''        rsPlanoPagamento!DataVencParcela = dtDataVencimento
''''        rsPlanoPagamento!ValorJurosParcela = RetornoCalculoJurosFCO(dtDataInicio, dtDataVencimento, dblPercTaxaJuros, CValorSaldoRestante, dblPropSpreadBB)
''''        rsPlanoPagamento!ValorAmortizacaoParcela = CValorAmortizacao
''''        rsPlanoPagamento!ValorParcela = rsPlanoPagamento!ValorAmortizacaoParcela + rsPlanoPagamento!ValorJurosParcela
''''        rsPlanoPagamento!SaldoDevedorParaCalculo = CValorSaldoRestante
''''        rsPlanoPagamento!CodSituacaoParcela = COD_SIT_PARC_NORMAL
''''        rsPlanoPagamento!QtdDiasParcela = DateDiff("d", dtDataInicio, dtDataVencimento)
''''        rsPlanoPagamento!CodTipoParcela = COD_TIPO_PARCELA_ENCARGO_PRINCIPAL
''''        rsPlanoPagamento!TipoParcela = "Princpal + Juros"
''''        rsPlanoPagamento!PercTaxaJuros = dblPercTaxaJuros
''''        rsPlanoPagamento!DataLiberacao = dtDataLiberacao
''''
''''        rsPlanoPagamento.Update
''''
''''        dtDataInicio = dtDataVencimento
''''
''''        dtDataVencimento = RetornaDataVencimento(iPeriodicidadeAmortizacao, dtDataInicio, 1)
''''
''''        CValorSaldoRestante = CValorSaldoRestante - CValorAmortizacao
''''
''''        If dtDataVencimento = dtDataFim Then
''''            CValorAmortizacao = cValorSaldoDevedor - Round(CValorAmortizacao * (iQtdAmortizacao - 1), 2)
''''        End If
''''
''''        iCt = iCt + 1
''''
''''    Loop
''''
''''    rsPlanoPagamento.MoveFirst
''''
''''    Set CriaEstruturaPlanoPagamento = rsPlanoPagamento
''''
''''    Exit Function
''''Resume
''''l_Error:
''''    MsgBox "Error " & Err.Number & " (" & Err.Description & ") in procedure CriaEstruturaPlanoPagamento of Módulo de classe CMontaQuery"
''''End Function
''''
''''
''''
''''
